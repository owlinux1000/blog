<!DOCTYPE html>
<html lang="en-us">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Simple minimalist theme">
<meta name="keywords" content="minimalist,blog,goa,hugo,developer">

<base href="https://owlinux1000.github.io/">

<title>
  $ make life - 令和元年のうちに抑えておくLinuxマルウェア入門 
</title>

<meta name="generator" content="Hugo 0.54.0" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400|Roboto+Slab:400,700|Roboto:300,300i,400,400i,500,500i,700,700i">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
<link rel="stylesheet" href="https://owlinux1000.github.io/css/main.css">
<link rel="stylesheet" href="https://owlinux1000.github.io/css/custom.css">




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

</head>
<body lang="en-us">
<div class="container">


<header class="row text-left title">
  <h1 class="title">令和元年のうちに抑えておくLinuxマルウェア入門</h1>
</header>
<section id="category-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-left meta">
        PUBLISHED ON DEC 5, 2019 
      
    </h6>
  </div>
  
</section>
<section id="content-pane" class="row">
  <div class="col-md-12 text-justify content">
    
    

<h2 id="はじめに">はじめに</h2>

<p>本記事では、私の頭の中に断片的に蓄積されているLinuxマルウェアに関する知見を年末の大掃除がてら整理してみる。おそらく一般的なことが多いと思う。<a href="https://www.packtpub.com/networking-and-servers/mastering-malware-analysis">Mastering Malware Analysis</a>にはこの手のことが纏まっていたので学びたい人は読むと良い。</p>

<h2 id="1-感染経路">1. 感染経路</h2>

<p>ここでは、Linuxマルウェアに感染する主な経路について紹介する。この手のLinuxマルウェアやIoTマルウェアの多くは、<strong>弱いデフォルトパスワード</strong> などを狙う場合が多い。典型的なのは、<code>admin:admin</code>や<code>root:root</code>などだ。その他、プロトコルスタック周りの脆弱性を突かれることによるケースも多く存在する。これによりいったんLinuxシステムに侵入されるとLinuxマルウェアは、次の永続化機構などで足場を固める行動に移る。</p>

<h2 id="2-永続化機構">2. 永続化機構</h2>

<p>ここではLinuxマルウェアが利用する代表的な永続化機構について紹介する。Windowsの<code>CurrenVersion\Run</code>キー等への書き込みと同様に永続化するための機構を備えている場合が多い。もしLinuxマルウェアに感染している際は以下に記載したようなファイルやディレクトリ群を調査するのが良い。</p>

<ul>
<li>cron

<ul>
<li><code>/etc/crontab</code></li>
<li><code>/etc/cron.d</code></li>
<li><code>/etc/cron.daily</code>など</li>
</ul></li>
<li>シェルのprofile系

<ul>
<li><code>.bash_profile</code></li>
<li><code>.profile</code>など</li>
</ul></li>
<li>サービス

<ul>
<li><code>/etc/inittab</code></li>
<li><code>/etc/rc?.d</code></li>
<li><code>/etc/system/</code></li>
</ul></li>
<li>正規ファイルの置き換え</li>
</ul>

<p>多くの場合は、これらのファイルにまた新たなマルウェアをダウンロードしたり、あるいはプロセスを複数起動するような処理が書き込まれていることが多い。</p>

<h2 id="3-権限昇格">3. 権限昇格</h2>

<p>ここでは、Linuxマルウェアによる一般権限から管理者権限への権限昇格などに使われる手法を紹介する。Linuxにおける権限昇格の多くは、SUID/SGIDなバイナリの脆弱性を突いたものである。SUID/SGIDは、実行したユーザに関わらずバイナリの所有者や所有グループで実行されることになる。例えば、パスワード設定を行う<code>passwd</code>コマンドなどはSUIDの設定がされている。そのため一般権限で実行しても所有者のrootユーザで実行された扱いになる。</p>

<pre><code class="language-sh">$ ls -la (which passwd)
-rwsr-xr-x 1 root root 59640 Mar 23  2019 /usr/bin/passwd*
</code></pre>

<p>このようなバイナリに脆弱性があるとすぐに管理者権限などを持っていかれる可能性が高いため、SUID/SGIDの設定をする際には十分に注意してほしい。</p>

<h2 id="4-c-cサーバとの通信方法">4. C&amp;Cサーバとの通信方法</h2>

<p>実際にLinuxマルウェアに感染すると多くの場合、C&amp;Cサーバとの通信が行われる。LinuxマルウェアがC&amp;Cサーバと通信を行う際には、<code>wget</code>や<code>curl</code>といった代表的なHTTPリクエストが可能なコマンドが多く利用される。バイナリ中で、これらのコマンドを呼び出して実行する場合も存在する。この他、正規の通信にまぎれさせるような形で行うものもある。例えば<code>ping</code>コマンドの<code>-p</code> オプションでデータを送信したり、送信データを暗号化して分割した値をサブドメインとして名前解決することで送ったりなどだ。</p>

<h2 id="5-表層解析">5. 表層解析</h2>

<p>Linuxマルウェアの表層解析をする際には、<code>file</code>コマンドと<code>strings</code>コマンドが役に立つ。これらのコマンドは言及するまでもないだろう。ちなみに<code>strings</code>コマンドを使う際は、文字列として認識する最低文字列長を設定する<code>-n</code>オプションを利用することをおすすめする。個人的なおすすめ値は<code>-n 7</code>だ。その他個人的に便利でよく使うのが、<a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/base64dump.py">base64dump.py</a> だ。これは、REMnuxなどでも導入されている対象ファイル中からbase64でエンコードされているような箇所を抜き出してくれる便利ツールだ。</p>

<h2 id="6-動的解析">6. 動的解析</h2>

<p>Linuxマルウェアの動的解析をする際には、まずおすすめするのが<code>strace</code> や<code>ltrace</code>コマンドである。前者はシステムコール、後者はライブラリ関数呼び出しをトレースしてくれる。多くの場合、<code>strace</code>をかませることで、大まかな挙動がわかるケースが多い。また、これらのコマンドを利用する際には<code>-f</code>オプションを使ってスレッドも追うように設定したり、<code>-s</code>や<code>-v</code>のオプションも効果的だ。特に以下のシステムコールに着目するべき。</p>

<ul>
<li>open/creat</li>
<li>read/write</li>
<li>readdir</li>
<li>access</li>
<li>chmod</li>
<li>chdir/chroot</li>
<li>rename</li>
<li>unlink</li>
<li>socket, connect, bind, listen, accept</li>
<li>fork/execve</li>
<li>prctl, signal, ptrace</li>
</ul>

<p>また、Linux環境であるためGDBを使った解析も効果的だ。名前のgdbを使うのではなく、<a href="https://github.com/longld/peda">gdb-peda</a> などのプラグインを利用することをおすすめする。
C&amp;Cサーバへの通信なども確認したい場合があると思うので、動的解析する際は<code>tcpdump</code>でパケットをキャプチャしておくのが望ましい。</p>

<h2 id="7-静的解析">7. 静的解析</h2>

<p>ここは、Windowsマルウェアとあまり変わらずIDAやGhidraを使うのが良い。軽く見たい程度であればobjdumpでもOK。特に静的解析に特化したようなツールは知らないため割愛。</p>

<h2 id="8-自己防衛機能">8. 自己防衛機能</h2>

<p>マルウェアによっては解析を妨げるような処理が含まれている場合が存在する。代表的なものをいくつか記載する。簡単なPoCは、<a href="https://github.com/owlinux1000/anti-debugging-sample">anti-debugging-sample</a>にまとめておいた。</p>

<ul>
<li>ptraceによるトレースやデバッガの検知</li>
<li>プロセス名、コマンドライン名のよくあるプログラム名への偽装

<ul>
<li><code>argv[0]</code> の書き換え(<code>/proc/$PID/cmdline</code>が偽装される)</li>
<li><code>prctl</code> によるプロセス名偽装(<code>/proc/$PID/status</code>のNameが偽装される)</li>
<li>上記二つが行われていると<code>ps</code>コマンドで見たときにパッと気づけない</li>
<li><code>sshd</code>などそれっぽいプロセス名に偽装されていることが多い</li>
</ul></li>
</ul>

<h2 id="おわりに">おわりに</h2>

<p>広く浅くLinuxマルウェアについて紹介してきた。Linuxマルウェアは特にIoTマルウェアとして猛威をふるっているので、何かと解析することはあると思うので、その際には本記事で得た知見を生かしてくれるとうれしい。</p>

  </div>
</section>
<section id="tag-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-right meta">
      
    </h6>
  </div>
  
</section>








<section id="menu-pane" class="row menu text-center">
  
  
  <span><a class="menu-item" href="https://owlinux1000.github.io/blog/powershell_ctf_utw/">&lt; prev | </a></span>
  
  
  <span><a class="menu-item" href="/blog">blog</a></span>
  
  
  
  <h4 class="text-center"><a class="menu-item" href="https://owlinux1000.github.io/">home</a></h4>
</section>



<footer class="row text-center footer">
  <hr />
  
</footer>

</div>




<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/main.js"></script>
<script src="js/custom.js"></script>
</body>
</html>


